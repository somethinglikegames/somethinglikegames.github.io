<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/sass/main.min.2005bac08fea9f984d088cc097e64343345cd7ec419e82e7f12e4e0a21a791efd937755054c629c9ce1b911bec429935b92a6d1608219c876ba4b85c43037527.css integrity="sha512-IAW6wI/qn5hNCIzAl+ZDQzRc1+xBnoLn8S5OCiGnke/ZN3VQVMYpyc4bkRvsQpk1uSptFgghnIdrpLhcQwN1Jw=="><link rel=stylesheet href=/css/all.min.a0921f068fa9017ba1288b77420fbde17d89619431fab12b4d996e3e124af17337ac1b80bc2bb62458509e6033ace757405b5881b0c1d0db837dd64c8783b607.css integrity="sha512-oJIfBo+pAXuhKIt3Qg+94X2JYZQx+rErTZluPhJK8XM3rBuAvCu2JFhQnmAzrOdXQFtYgbDB0NuDfdZMh4O2Bw=="><title>Something Like Games | Netzwerktutorial 3: Login 1 - Der Game-Client</title><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=description content="In diesem Teil der Tutorialserie geht es um den ersten Teil des Loginvorgangs. Nach Ablauf des Logins wird der Game-Client soweit besprochen, dass er mit dem Gateway-Server kommunizieren kann."><meta itemprop=description content="In diesem Teil der Tutorialserie geht es um den ersten Teil des Loginvorgangs. Nach Ablauf des Logins wird der Game-Client soweit besprochen, dass er mit dem Gateway-Server kommunizieren kann."><meta name=twitter:description content="In diesem Teil der Tutorialserie geht es um den ersten Teil des Loginvorgangs. Nach Ablauf des Logins wird der Game-Client soweit besprochen, dass er mit dem Gateway-Server kommunizieren kann."><meta property="twitter:image" content="https://www.somethinglikegames.de/images/blog/2023/network-tutorial-1-overview/godot_networking.webp"><meta property="og:description" content="In diesem Teil der Tutorialserie geht es um den ersten Teil des Loginvorgangs. Nach Ablauf des Logins wird der Game-Client soweit besprochen, dass er mit dem Gateway-Server kommunizieren kann."><meta property="og:image" content="https://www.somethinglikegames.de/images/blog/2023/network-tutorial-1-overview/godot_networking.webp"></head><body><nav class="navbar is-light" role=navigation aria-label="main navigation"><div class=navbar-brand><a href=/de/ class=navbar-item><img src=/images/brand.webp alt="Something Like Games" width=128px height=28></a>
<a role=checkbox class=navbar-burger aria-label=menu aria-expanded=false data-target=navigation><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=navigation class=navbar-menu><div class=navbar-end><div class=navbar-item><a href=/de/ class="nav link icon-text"><span class=icon><i class='fa fa-home'></i></span><span>Home</span></a></div><div class=navbar-item><a href=/de/contact/ class="nav link icon-text"><span class=icon><i class='fa fa-mail-bulk'></i></span><span>Kontakt</span></a></div><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link href=#>Deutsch (de)</a><div class="navbar-dropdown is-right"><a href=https://www.somethinglikegames.de/en/blog/2023/network-tutorial-3-login-1/ lang=en class=navbar-item>English (en)</a></div></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-one-fifth"><section id=site-sidebar class=is-hidden-mobile><section id=site-intro class="block has-text-centered"><a href=/de/><img src=/images/logo.webp class=circle width=128px height=128px alt=somethinglikegames.de></a><header></header><main><p>Mein persönlicher Blog über Spieleentwicklung als Einzelperson in Teilzeit</p></main><footer class="footer has-no-background"><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-d01dd933d7></span>
<script id=cloaked-script-d01dd933d7>var cloakElement=document.getElementById("cloaked-d01dd933d7"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></footer></section><div class=block><hr></div><section id=categories class="block categories"><header><h1><a href=/de/categories><span class=icon-text><span class=icon><i class="fa fa-folders"></i></span><span>Kategorien</span></span></a></h1></header><ul><li><a href=/de/categories/tutorials/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>tutorials</span></span><span class=count>9</span></a><li><a href=/de/categories/misc/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>misc</span></span><span class=count>5</span></a><li><a href=/de/categories/news/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>news</span></span><span class=count>2</span></a></li></ul></section></section></div><div class=column><article class=card><div class=card-image><a href=/de/blog/2023/network-tutorial-3-login-1/ class=cover-image style="--bg-image:url('https://www.somethinglikegames.de/images/blog/2023/network-tutorial-1-overview/godot_networking.webp')"><img class=cover src=https://www.somethinglikegames.de/images/blog/2023/network-tutorial-1-overview/godot_networking.webp alt="Godot Engine Logos, die miteinander 'kommunizieren'"></a><div class=copyright><a href=https://github.com/godotengine/godot/blob/master/LOGO_LICENSE.md class=has-text-grey target=_blank rel="noopener nofollow noreferrer">Godot Engine Logo is licensed under CC-BY-4.0 international</a></div></div><header class=card-header><div class=card-header-title><h2 class="title is-2"><a href=/de/blog/2023/network-tutorial-3-login-1/>Netzwerktutorial 3: Login 1 - Der Game-Client</a></h2></div></header><div class="card-content is-size-5 content"><div class=columns><div class=column><time datetime="2023-02-26 12:00:00 +0100 +0100">26.02.2023</time></div></div><div class=columns><div class=column><div class=tags><span class="tag is-info is-light"><a href=/de/categories/tutorials/ class=has-text-info><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span>
<span>Tutorials</span></span></a></span>
<span class="tag is-link is-light"><a href=/de/tags/networking-tutorial/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking-Tutorial</span></span></a></span>
<span class="tag is-link is-light"><a href=/de/tags/godot-engine/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Godot Engine</span></span></a></span>
<span class="tag is-link is-light"><a href=/de/tags/networking/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking</span></span></a></span></div></div></div><p>Der Quellcode zu den Artikeln ist in diesem <a href=https://github.com/somethinglikegames/godot4-network-tutorial target=_blank rel="noopener nofollow noreferrer">GitHub Repository</a> zu finden. Die folgende Liste zeigt alle bislang erschienenen Artikel dieser Serie:</p><ol><li><a href=/de/blog/2023/network-tutorial-1-overview/>Netzwerktutorial 1: Allgemeines und Übersicht</a></li><li><a href=/de/blog/2023/network-tutorial-2-walking-skeleton/>Netzwerktutorial 2: Das "gehende Skelett"</a></li><li>Netzwerktutorial 3: Login 1 - Der Game-Client</li><li><a href=/de/blog/2023/network-tutorial-4-login-2/>Netzwerktutorial 4: Login 2 - Gateway- und Authentication-Server</a></li><li><a href=/de/blog/2023/network-tutorial-5-login-3/>Netzwerktutorial 5: Login 3 - World-Server</a></li><li><a href=/de/blog/2023/network-tutorial-6-dtls/>Netzwerktutorial 6: Verschlüsselte Verbindungen mit Hilfe von DTLS</a></li></ol><p>Mit Hilfe des <a href=/de/blog/2023/network-tutorial-2-walking-skeleton/>letzten Artikels</a> haben wir nun ein Grundgerüst, bestehend aus drei Servern, die auf den UDP-Ports <code>1909</code>-<code>1911</code> laufen und uns per Konsolenausgabe über Verbindungsaufbau/-abbau von Clients informieren. Dieser Artikel beschäftigt sich mit dem ersten Teil des Loginvorgangs und wir erstellen den Game-Client soweit, dass er eine Verbindung zum Gateway-Server aufbaut und die Logindaten dorthin verschickt. Aber zuvor besprechen wir noch etwas allgemeiner den Loginvorgang und RPCs bei Godot.</p><h3 class="title is-4" id=loginvorgang>Loginvorgang</h3><p>In der klassischen synchronen Softwareentwicklung würde die geplante Loginsequenz wie in dem nachfolgenden Sequenzdiagramm aussehen. Auch wenn synchrone Programmierung oftmals bequemer für den Entwickler ist, erzielt sie gerade bei rechenintensiven oder latenzbehafteten Aufrufen, also immer wenn ein Netzwerk involviert ist, für den Nutzer schlechte Ergebnisse. Dazu kommt, dass die auf <a href=http://enet.bespin.org/ target=_blank rel="noopener nofollow noreferrer">ENet</a> basierende Netzwerkschicht in Godot auf asynchrone Kommunikation ausgelegt ist. Denn es werden auch Broadcasts unterstützt, bei denen der Server bei allen aktuell verbundenen Clients einen Funktionsaufruf, einen sogenannten <em>Remote Procedure Call</em> (RPC), auslösen kann. Wie lange soll dann ein solcher Aufruf dauern? Bis alle, also bis zu 4k, Clients ihr Resultat zurückgeliefert haben? Zumal man zusätzlich bedenken muss, dass bei den Godot-RPCs auch konfiguriert werden kann, dass solche Aufrufe unzuverlässig zugestellt werden können, es also keine Garantie gibt, dass ein Client den Aufruf bekommen hat, oder nicht.</p><figure class="title is-6 center"><img src=/images/blog/2023/network-tutorial-3-login-1/login_sequence_synchrone.webp alt="Synchrone Loginsequenz"><figcaption><h4>Synchrone Loginsequenz</h4></figcaption></figure><p>Aus diesem Grund nehmen wir uns den synchronen Ablauf zum Vorbild und bilden ihn asynchron nach. Das bedeutet, dass die jeweiligen RPCs, wie im Sequenzdiagramm eingezeichnet, stattfinden. Die eingezeichnete &ldquo;Wartezeit&rdquo; wiederum kann nun anderweitig genutzt werden. Die GUI des Game-Clients kann z.B. weiterhin auf Nutzereingaben reagieren oder auch eine Fortschrittsanzeige anzeigen und aktualisieren. Der Gateway-Server kann im selben Thread auf weitere Login-Requests reagieren. Entscheidend ist, dass die eingezeichneten Antworten nun auch RPCs sind und der Gateway-Server in der Lage sein muss, die Antwort an den ursprünglichen Aufrufer weiterzuleiten.</p><h3 class="title is-4" id=remote-procedure-call-rpc>Remote Procedure Call (RPC)</h3><p>Bei RPC-basierter Kommunikation handelt es sich, neben der nachrichtenbasierten Kommunikation, um ein grundlegendes Modell der Netzwerkprogrammierung. Das Schöne dabei ist, dass es für den Entwickler ähnlich wie ein lokaler Funktionsaufruf ist. Bei der von uns verwendeten Netzwerkschicht von Godot <a href=http://enet.bespin.org/ target=_blank rel="noopener nofollow noreferrer">ENet</a> sind alle RPC-Aufrufe asynchrone Aufrufe, also generell schon mal Funktionen mit Rückgabewert <code>void</code>. Wenn man aber nach synchroner Denkweise einen Rückgabewert haben möchte bzw. muss, um weiter &ldquo;arbeiten&rdquo; zu können, muss man ebenfalls eine Funktion zur Verfügung stellen, einen sogenannten Callback, die der Kommunikationspartner dann mit dem Ergebnis (synchron: Rückgabewert) per RPC aufruft.</p><p>Zwischen Godot 3.x und Godot 4 hat sich einiges bei der Syntax im Netzwerkbereich getan. Ich werde hier zwar nur noch auf die neue Syntax eingehen, aber wer sich die alte Syntax anschauen möchte, wird sicherlich in der <a href=https://docs.godotengine.org/en/3.5/tutorials/networking/high_level_multiplayer.html#rpc target=_blank rel="noopener nofollow noreferrer">alten Dokumentation</a> dazu fündig. Die erste und größte Neuerung ist wohl die neue Annotation <code>@rpc</code> für alle Funktionen, die via RPC aufgerufen können werden soll.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> s_login_request(_username: <span style=color:#a6e22e>String</span>, _password: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>pass</span></span></span></code></pre></div><p>Es sind vier Parameter für <code>@rpc</code> vorgesehen:</p><dl><dt><code>mode</code></dt><dd>Legt fest, wer die Funktion aufrufen darf. Mögliche Werte sind <code>"authority"</code> (Standard) und <code>"any_peer"</code></dd><dt><code>sync</code></dt><dd>Bestimmt, ob die Funktion ausschließlich remote aufgerufen wird oder zusätzlich ebenfalls lokal. Mögliche Werte sind <code>"call_remote"</code> (Standard) und <code>"call_local"</code></dd><dt><code>transfer_mode</code></dt><dd>Es gibt insgesamt drei mögliche Modi. <code>unreliable</code> (Standard) bedeutet, dass die Funktionsaufrufe ohne weitere Garantien abgesendet werden. Mit <code>unreliable_ordered</code> kann festgelegt werden, dass immer nur die zuletzt abgeschickte Nachricht ausgewertet wird, wenn also zuerst A und dann B abgesendet werden und B vor A beim Empfänger ankommt, wird ausschließlich B ausgewertet und A verworfen. Kommt A vor B an, so wird natürlich zuerst A ausgewertet und anschließend B. Bei <code>reliable</code> werden Mechanismen etabliert, um die Ankunft der Nachricht/des Funktionsaufrufs zu garantieren (ein wenig wie bei TCP), was zur Folge hat, dass nach jedem <code>reliable</code>-Versand der Empfänger den Emfang quittieren muss, bevor die nächste <code>reliable</code>-Nachricht auf diesem Kanal verschickt werden kann.</dd><dt><code>channel</code></dt><dd>Bestimmt, auf welchem Kanal eine Nachricht/ein Funktionsaufruf stattfindet. Dabei sind alle Kanäle Teile der gleichen Netzwerkverbindung. Der Standardwert ist <code>0</code>, ansonsten sind, soweit ich das momentan absehen kann, alle anderen <code>int</code> Werte zugelassen. Durch unterschiedliche Kanäle kann man bspw. Latenzen, die durch <code>reliable</code> Aufrufe entstehen, verringern, indem man unterschiedliche <code>reliable</code> Aufrufe über unterschiedliche Kanäle laufen lässt. Wie zuvor erklärt, wird ansonsten bei jedem <code>reliable</code> Funktionsaufruf auf die Quittierung des Empfängers gewartet, bevor der nächste <code>reliable</code> Funktionsaufruf auf dem Kanal verschickt werden kann. Ein weiterer essentieller Einsatzzweck für unterschiedliche Kanäle entsteht bei der Nutzung vom <code>transfer_mode</code> <code>unreliable_ordered</code>, da sich die Sortierung auf alle Netzwerknachrichten des Kanals bezieht und nicht nur auf gleiche Funktionsaufrufe. Dies hat zur Folge, dass bei 3 abgeschickten unterschiedlichen RPCs mit <code>unreliable_ordered</code> über den selben Kanal, abhängig von der Empfangsreihenfolge, 1 bis maximal 3 davon ausgeführt und alle nicht ausgeführten verworfen werden, auch wenn jeder Aufruf eine andere Funktion aufrufen sollte.</dd></dl><p>Die Reihenfolge der ersten drei Parameter ist, wie im Beispiel gezeigt, egal, aber die Angabe des Kanals muss immer als viertes Argument erfolgen.</p><p>Mehr Informationen und kleinere Beispiele zu diesem Thema finden sich auch im zugehörigen <a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-2/ target=_blank rel="noopener nofollow noreferrer">Blog-Post dieser Syntax-Änderung</a>.</p><p>Eine zweite Syntax-Änderung, die mit Godot 4 kommt, ist dass jedes <code>Callable</code> nun die Funktionen <code>rpc()</code> bzw. <code>rpc_id()</code> besitzt. Dadurch lässt sich der RPC direkt auf dem <code>Callable</code> aufrufen und man benötigt eigentlich keine weitere allgemeingültige Funktion mehr, der der Funktionsname per String übergeben werden muss. Dadurch fallen Umbenennungen von Funktionen schon direkt zur Compile-Zeit auf und nicht erst zur Laufzeit. Der Unterschied zwischen <code>rpc()</code> und <code>rpc_id()</code> ist, dass bei <code>rpc_id()</code> noch die Netzwerk-ID des Empfängers angegeben wird. Die neue Syntax im Einsatz sieht dann z.B. wie folgt aus:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span><span style=color:#75715e># Neue Syntax:</span>
</span></span><span style=display:flex><span>s_login_request<span style=color:#f92672>.</span>rpc_id(MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER, username, password)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Alternative/ bisherige Syntax:</span>
</span></span><span style=display:flex><span>rpc_id(MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER, <span style=color:#e6db74>&#34;s_login_request&#34;</span>, username, password)</span></span></code></pre></div><h3 class="title is-4" id=game-client>Game-Client</h3><h4 id=login-gui class="title is-5">Login-GUI (./scenes/gui/login_screen.tscn)</h4><figure class="is-pulled-left title is-6"><img src=/images/blog/2023/network-tutorial-3-login-1/game_client_login_scenetree.webp alt="SceneTree der Login-GUI"><figcaption><h4>SceneTree der Login-GUI.</h4></figcaption></figure><p>Nach einem langen inneren Kampf, ob ich wirklich eine Login-GUI bauen soll, fangen wir nun mit genau einer solchen GUI an. Vorab: Meine Kenntnisse bzgl. GUI-Design, vor allem mit Godot, sind ziemlich beschränkt. Mir geht es bei dieser GUI auch nicht um das schönste oder beste Design, sondern um eine möglichst sinnvolle Funktionalität für dieses Tutorial. Daher kann man in der GUI auch Netzwerk-Adresse und -Port für Gateway- und World-Server einstellen. Wie man am <code>SceneTree</code> erkennen kann, habe ich versucht, möglichst viel Funktionalität in möglichst wenig Design unterzubringen. Ich hatte nur zwei Kriterien an das Design: Erstens sollen die GUI-Elemente unabhängig von der Fenstergröße zentriert werden. Zweitens sollen Label und Eingabefelder (<code>LineEdit</code>) ordentlich untereinander stehen. Mit Hilfe von <code>CenterContainer</code> lässt sich die Anforderung des Zentrierens sehr einfach umsetzen, da dieser Container alle seine <code>Control</code> Kinder automatisch zentriert. Mein zweites Kriterium habe ich mit einem zweispaltigen <code>GridContainer</code> gelöst. Damit das wie gewünscht funktioniert, müssen die Kindelemente immer zwischen <code>Label</code> und Eingabefeld abwechseln. Damit dies auch für die Eingabefelder der Server-Einträge gelingt, habe ich die jeweiligen Textfelder (<code>LineEdit</code>) für Netzwerk-Adresse und -Port in einem <code>HBoxContainer</code> zusammengefasst, so passt es dann auch mit der alternierenden Reihenfolge. Um mir den Tippaufwand zu sparen, sind die Textfelder für Gateway- und World-Server schon passend auf <code>127.0.0.1</code> und <code>1910</code> bzw. <code>1909</code> vorbelegt. Die GUI sieht dann wie folgt aus:</p><figure class="is-pulled-left title is-6"><img src=/images/blog/2023/network-tutorial-3-login-1/game_client_login_gui.webp alt=Login-GUI><figcaption><h4>Login-GUI</h4></figcaption></figure><p>Passend dazu ist auch das zugehörige GDScript sehr einfach gehalten. Es besitzt nur zwei Funktionen:</p><ol><li><code>_on_login_pressed()</code>, die mit dem Signal <code>pressed</code> von <code>login_btn</code> verknüpft ist</li><li><code>reset()</code>, die die GUI wieder zurücksetzen soll</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Control</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> gw_server_addr_txt :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>GatewayServer<span style=color:#f92672>/</span>Server
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> gw_server_port_txt :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>GatewayServer<span style=color:#f92672>/</span>Port
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> world_server_addr_txt :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>WorldServer<span style=color:#f92672>/</span>Server
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> world_server_port_txt :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>WorldServer<span style=color:#f92672>/</span>Port
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> username_txt :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>Username
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> password_txt :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>Password
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> login_btn :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Center<span style=color:#f92672>/</span>Grid<span style=color:#f92672>/</span>Login
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#66d9ef>var</span> login : Callable
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#66d9ef>func</span> reset() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	login_btn<span style=color:#f92672>.</span>disabled <span style=color:#f92672>=</span> false
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#66d9ef>func</span> _on_login_pressed() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	login_btn<span style=color:#f92672>.</span>disabled <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	login<span style=color:#f92672>.</span>call(NetworkConnectionData<span style=color:#f92672>.</span>new(gw_server_addr_txt<span style=color:#f92672>.</span>text,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>			gw_server_port_txt<span style=color:#f92672>.</span>text as <span style=color:#a6e22e>int</span>),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>			NetworkConnectionData<span style=color:#f92672>.</span>new(world_server_addr_txt<span style=color:#f92672>.</span>text,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>			world_server_port_txt<span style=color:#f92672>.</span>text as <span style=color:#a6e22e>int</span>),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>			username_txt<span style=color:#f92672>.</span>text, password_txt<span style=color:#f92672>.</span>text)</span></span></code></pre></div><div class="message is-warning"><div class=message-body>Es sollte auffallen, dass ich auf jegliche Eingabevalidierung verzichtet habe, was man keinesfalls außerhalb einer Testanwendung machen darf. Ohne Validierung erhöht man nicht nur die Wahrscheinlichkeit für Fehleingaben seitens der Nutzer und reduziert dadurch die UX, sondern man vereinfacht auch Angriffe auf das eigene Backend, da man bspw. 1 GB Text über jegliche Eingabefelder an das Backend schicken kann und dieser auf diese Datenmengen wahrscheinlich nicht ausgelegt ist.</div></div><p>Die ganze &ldquo;Magie&rdquo; dieses Skripts findet innerhalb von <code>_on_login_pressed()</code> statt. Dort wird zuerst <code>login_btn</code> deaktiviert (Zeile 19), um ein Mehrfachdrücken zu verhindern. Anschließend wird ein <code>Callable</code> namens <code>login</code> mit den Inhalten der Eingabefelder aufgerufen. Was sich genau hinter <code>login</code> verbirgt, sehen wir uns gleich an. Zuerst habe ich noch eine neue Klasse namens <code>NetworkConnectionData</code> in <code>./scripts/classes/network_connection_data.gd</code> hinzugefügt. Wie man im nachfolgenden Quellcode sehen kann, handelt es sich dabei lediglich um einen einfachen Datencontainer, der Netzwerk-Adresse und -Port bündeln soll und noch eine <code>_to_string()</code> Funktion besitzt, um bessere Konsolenausgaben zu erzeugen:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>class_name NetworkConnectionData
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>var</span> address: <span style=color:#a6e22e>String</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>var</span> port: <span style=color:#a6e22e>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>func</span> _init(_address: <span style=color:#a6e22e>String</span>, _port: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	address <span style=color:#f92672>=</span> _address
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	port <span style=color:#f92672>=</span> _port
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#66d9ef>func</span> _to_string() <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>String</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>:</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [address, port]</span></span></code></pre></div><h4 id=scenehandler class="title is-5">SceneHandler (./scenes/main.tscn)</h4><p>Wie im <a href=/de/blog/2023/network-tutorial-2-walking-skeleton/>vorigen Artikel</a> bereits kurz erwähnt, möchte ich die Startszene (<code>./scenes/main.tscn</code>) des Game-Clients als <em>SceneHandler</em> konzipieren. Das heißt, der gesamte Kontrollfluss des Game-Clients wird über diese Szene und das zugehörige GDScript gesteuert. Aus diesem Grund ist dort auch der notwendige <em>Glue</em>-Code zu finden, um die <em>Verdrahtung</em> von Signalen, Callbacks, Abhängigkeiten etc. durchzuführen:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>var</span> login_screen :<span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scenes/gui/login_screen.tscn&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>var</span> gateway_server : <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>var</span> world_server_data : NetworkConnectionData
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	_load_login_screen()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#66d9ef>func</span> _load_login_screen() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> get_children():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		c<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#66d9ef>var</span> instance <span style=color:#f92672>=</span> login_screen<span style=color:#f92672>.</span>instantiate()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	instance<span style=color:#f92672>.</span>login <span style=color:#f92672>=</span> _login
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	add_child(instance)</span></span></code></pre></div><p>Beim Start des Game-Clients wird in <code>_ready()</code> die Funktion <code>_load_login_screen()</code> (Zeile 10) aufgerufen. Die Aufgabe dieser Funktion ist es, die zuvor vorgestellte Szene der Login-GUI zu initialisieren und zu laden. Bevor dies aber geschieht, wird &ldquo;aufgeräumt&rdquo;. Dafür werden in Zeile 14 alle Kinder der Szene durchlaufen, um sie für die Löschung vorzumerken. Anschließend wird der vorgeladene <code>login_screen</code> (Zeile 3) instanziiert, der Callback <code>login</code> wird gesetzt und dann wird die Login-GUI dem aktuellen <code>SceneTree</code> hinzugefügt (Zeile 18).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#66d9ef>func</span> _login(gw_server: NetworkConnectionData, wrld_server: NetworkConnectionData,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>			username: <span style=color:#a6e22e>String</span>, password: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	world_server_data <span style=color:#f92672>=</span> wrld_server
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	gateway_server <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	gateway_server<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GatewayServer&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	add_child(gateway_server)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	gateway_server<span style=color:#f92672>.</span>set_script(load(<span style=color:#e6db74>&#34;res://scenes/network/gateway_server.gd&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	get_tree()<span style=color:#f92672>.</span>set_multiplayer(SceneMultiplayer<span style=color:#f92672>.</span>new(), <span style=color:#f92672>^</span><span style=color:#e6db74>&#34;/root/Main/GatewayServer&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	gateway_server<span style=color:#f92672>.</span>gateway_server <span style=color:#f92672>=</span> gw_server
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	gateway_server<span style=color:#f92672>.</span>callback <span style=color:#f92672>=</span> _login_callback
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	gateway_server<span style=color:#f92672>.</span>login_to_server(username, password)</span></span></code></pre></div><p>Wie wir ja bereits <a href=#login-gui>im Abschnitt zuvor</a> gesehen haben, wird der übergebene Callback <code>_login()</code> (Zeile 21-22) mit den Daten aller Eingabefelder der Login-GUI aufgerufen . Die Netzwerkkoordinaten des World-Servers werden in einer lokalen Variable für die spätere Verwendung gespeichert, während alle anderen Informationen direkt weiterverarbeitet werden. Dafür wird ab Zeile 24 ein <code>Node</code> für den Gateway-Server erzeugt, benannt, dem <code>SceneTree</code> hinzugefügt und initialisiert. Am Ende wird noch die Funktion <code>login_to_server()</code> des Gateway-Servers aufgerufen, wodurch dann die Netzwerkverbindung zum Gateway-Server aufgebaut wird, was wir uns im <a href=#game-client-gw-server>nächsten Abschnitt</a> näher ansehen werden.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#66d9ef>func</span> _login_callback(return_code: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	remove_child(gateway_server)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		print(<span style=color:#e6db74>&#34;Login was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>		print(<span style=color:#e6db74>&#34;Current Token is: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>		<span style=color:#75715e># Connect to World Server</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>	<span style=color:#66d9ef>else</span> :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		print(<span style=color:#e6db74>&#34;Something went wrong…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>Die Funktion <code>_login_callback()</code> (ab Zeile 34) beherbergt den Callback für den Gateway-Server. Dort wird der <code>Node</code> des Gateway-Servers wieder gelöscht, da er nun nicht mehr benötigt wird. Anschließend wird aktuell im Erfolgsfall eine kleine Nachricht und der erhaltene Token als Konsolenmeldung ausgegeben. Später soll hier dann, mit Hilfe des Tokens, der Kontakt zum World-Server hergestellt werden, aber soweit sind wir noch nicht. Im Fehlerfall wird eine kleine Debug-Nachricht ausgegeben und anschließend die Funktion <code>reset()</code> der <a href=#login-gui>Login-GUI</a> aufgerufen.</p><h4 id=game-client-gw-server class="title is-5">Gateway-Server-Client (./scenes/network/gateway_server.gd)</h4><p>Die Aufgabe des Gateway-Server-Clients ist es, unschwer zu erraten, die Kommunikation mit dem Gateway-Server zu übernehmen. Zum &ldquo;Leben&rdquo; erweckt wird er, wie wir bereits besprochen haben, im <a href=#scenehandler>SceneHandler</a>, wo, nach der Instanziierung und Initialisierung, die Funktion <code>login_to_server()</code> aufgerufen wird.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>var</span> network :<span style=color:#f92672>=</span> ENetMultiplayerPeer<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>var</span> gateway_server : NetworkConnectionData
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>var</span> username : <span style=color:#a6e22e>String</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>var</span> password : <span style=color:#a6e22e>String</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>var</span> callback : Callable
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>func</span> login_to_server(_username: <span style=color:#a6e22e>String</span>, _password: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	username <span style=color:#f92672>=</span> _username
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	password <span style=color:#f92672>=</span> _password
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	print(<span style=color:#e6db74>&#34;Connecting to </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> gateway_server<span style=color:#f92672>.</span>to_string())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>var</span> ret <span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>create_client(gateway_server<span style=color:#f92672>.</span>address, gateway_server<span style=color:#f92672>.</span>port)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>if</span> ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		get_multiplayer()<span style=color:#f92672>.</span>multiplayer_peer <span style=color:#f92672>=</span> network
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>connect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		get_multiplayer()<span style=color:#f92672>.</span>connection_failed<span style=color:#f92672>.</span>connect(_on_connection_failed<span style=color:#f92672>.</span>bind(FAILED))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		_on_connection_failed(ret)</span></span></code></pre></div><p>Um Kontakt mit dem Gateway-Server aufzunehmen wird in Zeile 14 zunächst ein ENet-Client erzeugt. Wenn dies erfolgreich war, werden, ähnlich wie im <a href=/de/blog/2023/network-tutorial-2-walking-skeleton/>letzten Tutorial</a>, der <code>ENetMultiplayerPeer</code> im <code>Multiplayer</code>-Objekt hinterlegt und die Signale <code>connected_to_server</code> und <code>connection_failed</code> verknüpft. Im Fehlerfall wird direkt die Funktion <code>_on_connection_failed()</code> aufgerufen, wo dann die Fehlerbehandlung getriggert wird.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#66d9ef>func</span> _on_connection_failed(ret: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	print(<span style=color:#e6db74>&#34;Failed to connect to gateway server on </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, errorcode was </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>			<span style=color:#f92672>%</span> [gateway_server<span style=color:#f92672>.</span>to_string(), ret])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	callback<span style=color:#f92672>.</span>call(ret, <span style=color:#e6db74>&#34;&#34;</span>)</span></span></code></pre></div><p>Die Fehlerbehandlung in <code>_on_connection_failed()</code> ist sehr minimalistisch gehalten. Es wird eine kurze Konsolenmeldung ausgegeben und anschließend der <code>Callback</code>, den der <a href=#scenehandler>SceneHandler</a> hinterlegt hatte, aufgerufen. Diese Funktion wird nicht nur aufgerufen, wenn die Erzeugung des Netzwerk-Clients misslingt, sondern auch, wenn das Signal <code>connection_failed</code> getriggert wird.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#66d9ef>func</span> _on_connection_succeeded() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	print(<span style=color:#e6db74>&#34;Succesfully connected to gateway server </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [gateway_server<span style=color:#f92672>.</span>to_string()])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	print(<span style=color:#e6db74>&#34;send login request to gateway server&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	s_login_request<span style=color:#f92672>.</span>rpc_id(MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER, username, password)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#66d9ef>func</span> s_login_request(_username: <span style=color:#a6e22e>String</span>, _password: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	<span style=color:#66d9ef>pass</span> <span style=color:#75715e># on gateway server</span></span></span></code></pre></div><p>Wenn <code>_on_connection_succeeded()</code> nach erfolgreichem Verbindungsaufbau zum Gateway-Server durch <code>connected_to_server</code> aufgerufen wird, findet dort der eigentliche Loginvorgang statt. Dafür wird in Zeile 32 die Funktion <code>s_request_login</code> als RPC auf dem Server aufgerufen. Als Übergabeparameter steht bei der Funktion <code>rpc_id()</code> an erster Stelle immer die numerische ID des entfernten Systems. Der Server hat immer die ID 1, welche auch als Konstante <code>MultiplayerPeer.TARGET_PEER_SERVER</code> verfügbar ist. Alle weiteren Parameter werden an die aufgerufene Funktion übergeben.</p><p>Wie man ab Zeile 37 sehen kann, ist die Funktion <code>s_login_request()</code> auch im Client vorhanden, auch wenn sie ausschließlich auf dem Server aufgerufen wird. Neben identischem Netzwerkpfad und <code>SceneTree</code> müssen auf Server und Client auch alle Funktionen, die per RPC verfügbar sind, vorhanden sein. Dabei müssen alle <code>@rpc</code>-Parameter, der Funktionsname und auch die Übergabeparameter (Anzahl und Typ) übereinstimmen, während die Implementierungen hingegen unterschiedlich sein können und sollten. Dem Server kann egal sein, was der Client in seinen Funktionen macht und umgekehrt gilt es erst recht. Man bezeichnet solche funktionslosen Implementierungen auch gerne als Stubs. Um dennoch gut zwischen Server- und Client-Funktionen unterscheiden zu können beginnen bei mir aktuell alle Server-Funktionen mit <code>s_</code> und alle Client-Funktionen mit <code>c_</code>. Zusätzlich versuche ich, zusammengehörige Kommunikationsverläufe durch gleichnamige Funktionen, die dann entweder auf <code>_request</code> oder <code>_response</code> enden, sichtbar zu machen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#66d9ef>func</span> c_login_response(result: <span style=color:#a6e22e>bool</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	print(<span style=color:#e6db74>&#34;login response is </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> str(result))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	print(<span style=color:#e6db74>&#34;token is &#39;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>disconnect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	multiplayer<span style=color:#f92672>.</span>set_multiplayer_peer(null)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	network <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>	callback<span style=color:#f92672>.</span>call(OK <span style=color:#66d9ef>if</span> result <span style=color:#66d9ef>else</span> ERR_INVALID_DATA, token)</span></span></code></pre></div><p>Die Funktion <code>c_login_result()</code> (Zeile 43) wird vom Gateway-Server als Antwort auf <code>s_login_request()</code> aufgerufen. Nach der Ausgabe von Debug-Konsolenmeldungen wird die Verbindung zum Server getrennt und der <code>Callback</code> mit dem Ergebnis aufgerufen. Ab da verläuft es dann, wie zuvor im <a href=#scenehandler>SceneHandler</a> gezeigt, weiter. Im Fehlerfall wird der Login-Button wieder freigeschaltet und im Erfolgsfall gibt es weitere Konsolenausgaben, da ich die Kommunikation mit dem World-Server für ein späteres Tutorial geplant habe.</p><h3 class="title is-4" id=der-nächste-schritt>Der nächste Schritt</h3><p>Im nächsten Artikel wird es um den nächsten Schritt gehen: Der Gateway-Server nimmt den Login-Request des Game-Clients entgegen und leitet diesen an den Authentication-Server weiter, welcher die Logindaten verifiziert und im Erfolgsfall ein Token erstellt. Das Resultat wird dann über den Gateway-Server zurück an den Game-Client gesendet.</p></div></article><footer class=columns><div class="column has-text-left"><a href=/de/blog/2023/network-tutorial-2-walking-skeleton/ class="button right"><span class=icon-text><span class=icon><i class="fa fa-angle-left"></i></span><span>Netzwerktutorial 2: Das "gehende Skelett"</span></span></a></div><div class="column has-text-right"><a href=/de/blog/2023/network-tutorial-4-login-2/ class="button left"><span class=icon-text><span>Netzwerktutorial 4: Login 2 - Gateway- und Authentication-Server</span><span class=icon><i class="fa fa-angle-right"></i></span></span></a></div></footer></div></div></div></section><footer class=footer><div class="container is-fluid has-text-centered"><ul class=socnet-icons><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-6eb6c29b31></span>
<script id=cloaked-script-6eb6c29b31>var cloakElement=document.getElementById("cloaked-6eb6c29b31"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></ul><p class=copyright><a href=https://www.somethinglikegames.de/de/legal_notice/>Impressum</a> &mdash;
<a href=https://www.somethinglikegames.de/de/privacy_policy/>Datenschutzerklärung</a> &mdash;
©2023-2024 Tobias Wink<br>Powered by <a href=https://gohugo.io/ title=0.109.0 target=_blank rel=noopener>Hugo</a></p></div></footer><script src=/js/navbar.min.js defer></script>
<script src=/js/copy-code-button.min.js defer></script></body></html>