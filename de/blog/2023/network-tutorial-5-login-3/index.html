<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/sass/main.min.f6d044b67731fc418190a304668c848b0e240406fe652d5b63b8b82680bf6950585f1957e5bdc647161ed8b86a2ba218f28847056ae8f4c6c5d98d990c42f613.css integrity="sha512-9tBEtncx/EGBkKMEZoyEiw4kBAb+ZS1bY7i4JoC/aVBYXxlX5b3GRxYe2LhqK6IY8ohHBWro9MbF2Y2ZDEL2Ew=="><link rel=stylesheet href=/css/all.min.a0921f068fa9017ba1288b77420fbde17d89619431fab12b4d996e3e124af17337ac1b80bc2bb62458509e6033ace757405b5881b0c1d0db837dd64c8783b607.css integrity="sha512-oJIfBo+pAXuhKIt3Qg+94X2JYZQx+rErTZluPhJK8XM3rBuAvCu2JFhQnmAzrOdXQFtYgbDB0NuDfdZMh4O2Bw=="><title>Something Like Games | Netzwerktutorial 5: Login 3 - World-Server</title><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=description content="In diesem Teil der Tutorialserie geht es um den dritten Teil des Loginvorgangs. Mit dem Token des Authentication-Servers authentifiziert sich der Client am World-Server"><meta itemprop=description content="In diesem Teil der Tutorialserie geht es um den dritten Teil des Loginvorgangs. Mit dem Token des Authentication-Servers authentifiziert sich der Client am World-Server"><meta name=twitter:description content="In diesem Teil der Tutorialserie geht es um den dritten Teil des Loginvorgangs. Mit dem Token des Authentication-Servers authentifiziert sich der Client am World-Server"><meta property="twitter:image" content="https://www.somethinglikegames.de/images/blog/2023/network-tutorial-5-login-3/communicating_servers.webp"><meta property="og:description" content="In diesem Teil der Tutorialserie geht es um den dritten Teil des Loginvorgangs. Mit dem Token des Authentication-Servers authentifiziert sich der Client am World-Server"><meta property="og:image" content="https://www.somethinglikegames.de/images/blog/2023/network-tutorial-5-login-3/communicating_servers.webp"></head><body><nav class="navbar is-light" role=navigation aria-label="main navigation"><div class=navbar-brand><a href=/de/ class=navbar-item><img src=/images/brand.webp alt="Something Like Games" width=128px height=28></a>
<a role=checkbox class=navbar-burger aria-label=menu aria-expanded=false data-target=navigation><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=navigation class=navbar-menu><div class=navbar-end><div class=navbar-item><a href=/de/ class="nav link icon-text"><span class=icon><i class='fa fa-home'></i></span><span>Home</span></a></div><div class=navbar-item><a href=/de/contact/ class="nav link icon-text"><span class=icon><i class='fa fa-mail-bulk'></i></span><span>Kontakt</span></a></div><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link href=#>Deutsch (de)</a><div class="navbar-dropdown is-right"><a href=https://www.somethinglikegames.de/en/blog/2023/network-tutorial-5-login-3/ lang=en class=navbar-item>English (en)</a></div></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-one-fifth"><section id=site-sidebar class=is-hidden-mobile><section id=site-intro class="block has-text-centered"><a href=/de/><img src=/images/logo.webp class=circle width=128px height=128px alt=somethinglikegames.de></a><header></header><main><p>Mein persönlicher Blog über Spieleentwicklung als Einzelperson in Teilzeit</p></main><footer class="footer has-no-background"><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-76626e2187></span>
<script id=cloaked-script-76626e2187>var cloakElement=document.getElementById("cloaked-76626e2187"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></footer></section><div class=block><hr></div><section id=categories class="block categories"><header><h1><a href=/de/categories><span class=icon-text><span class=icon><i class="fa fa-folders"></i></span><span>Kategorien</span></span></a></h1></header><ul><li><a href=/de/categories/tutorials/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>tutorials</span></span><span class=count>9</span></a><li><a href=/de/categories/misc/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>misc</span></span><span class=count>3</span></a><li><a href=/de/categories/news/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>news</span></span><span class=count>2</span></a></li></ul></section></section></div><div class=column><article class=card><div class=card-image><a href=/de/blog/2023/network-tutorial-5-login-3/ class=cover-image style="--bg-image:url('https://www.somethinglikegames.de/images/blog/2023/network-tutorial-5-login-3/communicating_servers.webp')"><img class=cover src=https://www.somethinglikegames.de/images/blog/2023/network-tutorial-5-login-3/communicating_servers.webp alt="Godot Engine 'Server', die miteinander kommunizieren"></a><div class=copyright><a href=https://docs.midjourney.com/docs/terms-of-service class=has-text-grey target=_blank rel="noopener nofollow noreferrer"><img src=/images/cc-by-nc.webp alt=cc-by-nc> Midjourney</a></div></div><header class=card-header><div class=card-header-title><h2 class=title><a href=/de/blog/2023/network-tutorial-5-login-3/>Netzwerktutorial 5: Login 3 - World-Server</a></h2></div></header><div class="card-content is-size-5 content"><div class=columns><div class=column><time datetime="2023-03-26 12:00:00 +0100 +0100">26.03.2023</time></div></div><div class=columns><div class=column><div class=tags><span class="tag is-info is-light"><a href=/de/categories/tutorials/ class=has-text-info><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span>
<span>Tutorials</span></span></a></span>
<span class="tag is-link is-light"><a href=/de/tags/networking-tutorial/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking-Tutorial</span></span></a></span>
<span class="tag is-link is-light"><a href=/de/tags/godot-engine/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Godot Engine</span></span></a></span>
<span class="tag is-link is-light"><a href=/de/tags/networking/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking</span></span></a></span></div></div></div><p>Der Quellcode zu den Artikeln ist in diesem <a href=https://github.com/somethinglikegames/godot4-network-tutorial target=_blank rel="noopener nofollow noreferrer">GitHub Repository</a> zu finden. Die folgende Liste zeigt alle bislang erschienenen Artikel dieser Serie:</p><ol><li><a href=/de/blog/2023/network-tutorial-1-overview/>Netzwerktutorial 1: Allgemeines und Übersicht</a></li><li><a href=/de/blog/2023/network-tutorial-2-walking-skeleton/>Netzwerktutorial 2: Das "gehende Skelett"</a></li><li><a href=/de/blog/2023/network-tutorial-3-login-1/>Netzwerktutorial 3: Login 1 - Der Game-Client</a></li><li><a href=/de/blog/2023/network-tutorial-4-login-2/>Netzwerktutorial 4: Login 2 - Gateway- und Authentication-Server</a></li><li>Netzwerktutorial 5: Login 3 - World-Server</li><li><a href=/de/blog/2023/network-tutorial-6-dtls/>Netzwerktutorial 6: Verschlüsselte Verbindungen mit Hilfe von DTLS</a></li></ol><p>Im <a href=/de/blog/2023/network-tutorial-4-login-2/>letzten Artikel</a> haben wir den Gateway- und den Authentication-Server fertig implementiert, sodass der Game-Client für gültige Zugangsdaten ein Token ausgestellt bekommt. Dieses Token soll nun dazu dienen, sich am World-Server anzumelden. Daher werden wir in diesem Artikel den Game-Client so erweitern, dass er den Token zum World-Server weiterleitet, um anschließend den World-Server in die Lage zu versetzen, den Token zu verifizieren.</p><h3 class="title is-4" id=erweiterung-des-game-clients>Erweiterung des Game-Clients</h3><p>Bislang endet der Loginvorgang im Game-Client in folgender Funktion von <code>main.gd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#66d9ef>func</span> _login_callback(return_code: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>		print(<span style=color:#e6db74>&#34;Login was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		print(<span style=color:#e6db74>&#34;Current Token is: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>		<span style=color:#75715e># Connect to World Server</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	<span style=color:#66d9ef>else</span> :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>		print(<span style=color:#e6db74>&#34;Something went wrong…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>Wir haben bereits eine minimale Fehlerbehandlung, sodass die Oberfläche wieder zurückgesetzt wird, wenn etwas beim Login fehlschlägt (Zeile 41). Aber im Erfolgsfall enden wir aktuell beim einst gut gemeinten Kommentar in Zeile 38. Daher werden wir nun alle Vorbereitungen treffen, um den Kommentar durch wirkliche Funktionalität zu ersetzen. Zuerst legen wir ein neues Skript namens <code>world_server.gd</code> unterhalb von <code>scenes/network</code> an.</p><h4 class="title is-5" id=world-server-netzwerkclient-scenesnetworkworld_servergd>World-Server Netzwerkclient (./scenes/network/world_server.gd)</h4><p>Das nun nachfolgende Grundgerüst sollte überwiegend aus dem Client für den Gateway-Server bekannt sein. Wahrscheinlich sollte man die Gemeinsamkeiten mal in eine Oberklasse extrahieren, aber das würde es an dieser Stelle unübersichtlicher machen. Die Funktion <code>connect_to_server()</code> (Zeile 9-25) versucht, eine Verbindung zum World-Server aufzubauen. Server-Adresse und -Port werden wiederum aus einem <code>NetworkConnectionData</code>-Objekt genommen, welches wir vorher setzen müssen. Die berücksichtigten Fehlerfälle (Zeilen 18 und 20) werden wie gewohnt mit Hilfe von <code>_on_connection_failed()</code> abgehandelt. Um im Erfolgsfall in unserem Anmeldeprozess weiterzumachen, verbinden wir das Signal <code>connected_to_server</code> von unserem <code>MultiplayerAPI</code>-Objekt mit der Funktion <code>_on_connection_succeeded()</code> (Zeile 17).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>var</span> network :<span style=color:#f92672>=</span> ENetMultiplayerPeer<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>var</span> world_server : NetworkConnectionData
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>var</span> token : <span style=color:#a6e22e>String</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>var</span> callback : Callable
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>func</span> connect_to_server(_token: <span style=color:#a6e22e>String</span>, _callback: Callable) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	token <span style=color:#f92672>=</span> _token
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	callback <span style=color:#f92672>=</span> _callback
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	print(<span style=color:#e6db74>&#34;Connecting to </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> world_server<span style=color:#f92672>.</span>to_string())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>var</span> ret <span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>create_client(world_server<span style=color:#f92672>.</span>address, world_server<span style=color:#f92672>.</span>port)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>if</span> ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		get_multiplayer()<span style=color:#f92672>.</span>multiplayer_peer <span style=color:#f92672>=</span> network
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>connect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		get_multiplayer()<span style=color:#f92672>.</span>connection_failed<span style=color:#f92672>.</span>connect(_on_connection_failed<span style=color:#f92672>.</span>bind(FAILED))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		_on_connection_failed(ret)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#66d9ef>func</span> _on_connection_failed(ret: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	print(<span style=color:#e6db74>&#34;Failed to connect to world server on </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, errorcode was </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>			<span style=color:#f92672>%</span> [world_server<span style=color:#f92672>.</span>to_string(), ret])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	callback<span style=color:#f92672>.</span>call(ret, <span style=color:#e6db74>&#34;&#34;</span>)</span></span></code></pre></div><p>Sobald die Verbindung zum Server besteht, wird die Funktion <code>_on_connection_succeeded()</code> aufgerufen. Dort übermitteln wir dann den Token an den World-Server (Zeile 32). Das Resultat der tokenbasierten Anmeldung bekommen wir als Übergabeparameter der Funktion <code>c_login_response()</code>. Dort heben wir die Verknüpfung zum Signal <code>connected_to_server</code> auf, da wir ja nun nicht mehr im Besitz eines Tokens sind. Anschließend wird der übergebene Callback aufgerufen, sodass der eigentliche Programmfluss im Game-Client weiterlaufen kann.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#66d9ef>func</span> _on_connection_succeeded() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	print(<span style=color:#e6db74>&#34;Succesfully connected to world server </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [world_server<span style=color:#f92672>.</span>to_string()])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	print(<span style=color:#e6db74>&#34;send login request to world server&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	s_login_request<span style=color:#f92672>.</span>rpc_id(MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER, token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#66d9ef>func</span> s_login_request(_token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	<span style=color:#66d9ef>pass</span> <span style=color:#75715e># on game server</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#66d9ef>func</span> c_login_response(result: <span style=color:#a6e22e>bool</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	print(<span style=color:#e6db74>&#34;login request result is </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> str(result))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>disconnect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	callback<span style=color:#f92672>.</span>call(OK <span style=color:#66d9ef>if</span> result <span style=color:#66d9ef>else</span> ERR_INVALID_DATA)</span></span></code></pre></div><h4 class="title is-5" id=main-szene-scenesmaingd>Main-Szene (./scenes/main.gd)</h4><p>Nun haben wir unseren Netzwerkclient für den World-Server soweit vorbereitet, dass wir ihn nun auch in den eigentlichen Programmfluss integrieren können. Daher wird die bisherige Funktion <code>_login_callback()</code> so erweitert, dass sie nun den eben erstellten Netzwerkclient nutzt, um den Token an den World-Server zu übermitteln. Damit das nachfolgend gezeigte Code-Fragment auch funktioniert, habe ich noch eine neue Skriptvariable namens <code>world_server</code> vom Typ <code>Node</code> eingefügt, ähnlich wie die bereits vorher vorhandene Variable <code>gateway_server</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#66d9ef>func</span> _login_callback(return_code: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>	gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>		print(<span style=color:#e6db74>&#34;Current Token is: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>		world_server <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>		world_server<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WorldServer&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		add_child(world_server)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>		world_server<span style=color:#f92672>.</span>set_script(load(<span style=color:#e6db74>&#34;res://scenes/network/world_server.gd&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>		get_tree()<span style=color:#f92672>.</span>set_multiplayer(SceneMultiplayer<span style=color:#f92672>.</span>new(), <span style=color:#f92672>^</span><span style=color:#e6db74>&#34;/root/Main/WorldServer&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>		world_server<span style=color:#f92672>.</span>world_server <span style=color:#f92672>=</span> world_server_data
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>		world_server<span style=color:#f92672>.</span>connect_to_server(token, _world_server_callback)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#66d9ef>else</span> :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>		print(<span style=color:#e6db74>&#34;Something went wrong…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>Der neu hinzugefügte Quellcode (Zeilen 39-45) bindet den Netzwerkclient des World-Servers in den <code>SceneTree</code> ein, um anschließend dort die Funktion <code>login_to_server()</code> mit dem Token aufzurufen. Dafür habe ich den bereits aus <a href=/de/blog/2023/network-tutorial-3-login-1/#scenehandler>Tutorial 3</a> vorhandenen Code für den Gateway-Server-Client kopiert und an den World-Server angepasst. Als Callback wurde eine neue Funktion <code>_world_server_callback</code> übergeben, die vorerst folgendermaßen aussieht:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#66d9ef>func</span> _world_server_callback(return_code: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		print(<span style=color:#e6db74>&#34;Login to world server was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>		<span style=color:#75715e># Add further game logic</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>		gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>		gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>		print(<span style=color:#e6db74>&#34;Login to world server failed&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>Der Fehlerfall führt, wie zuvor bereits, zum Reset der Oberfläche, sodass ein erneuter Loginversuch unternommen werden kann, und im Erfolgsfall enden wir nun vorerst bei einem neuen Kommentar 😉 in Zeile 55.</p><h3 class="title is-4" id=erweiterung-des-world-servers>Erweiterung des World-Servers</h3><p>Auch wenn der Game-Client nun vorbereitet ist, um sich beim World-Server anzumelden, ist es der World-Server noch lange nicht. Dieser besteht bislang nur aus dem <a href=/de/blog/2023/network-tutorial-2-walking-skeleton/#the-server-base>Servergrundgerüst</a> und weiß noch gar nichts von einer Anmeldungsmöglichkeit, geschweige denn von Tokenvalidierung. Daher ist der erste Schritt die Installation des AddOns <a href=https://github.com/fenix-hub/godot-engine.jwt/releases target=_blank rel="noopener nofollow noreferrer">GDScript JWT</a>, ähnlich wie im <a href=/de/blog/2023/network-tutorial-4-login-2/#authentication-server>letzten Tutorial</a> beim Authentication-Server. Dafür laden wir zunächst das <a href=https://github.com/fenix-hub/godot-engine.jwt/releases target=_blank rel="noopener nofollow noreferrer">aktuellste Release</a> für Godot 4 herunter und entpacken den Ordner addons in unser Godot-Projekt des World-Servers. Anschließend muss das AddOn evtl. noch in den <code>Projekteinstellungen -> Plugins</code> aktiviert werden. Danach kopieren wir den <strong>öffentlichen</strong> Schlüssel vom Authentication-Server aus dem <a href=/de/blog/2023/network-tutorial-4-login-2/#authentication-server>letzten Tutorial</a> in einen neuen Ordner <code>crypto</code> unterhalb des World-Server-Projektverzeichnisses.</p><h4 class="title is-5" id=world-server-scenesnetworkworld_servergd>World-Server (./scenes/network/world_server.gd)</h4><p>Die Vorbereitungen für die Validierung der JWT-Tokens sind ähnlich wie für die Erzeugung <a href=/de/blog/2023/network-tutorial-4-login-2/#authentication-server>solcher Tokens</a>. Zuerst legen wir uns eine Skriptvariable vom Typ <code>JWTAlgorithm</code> an, um sie dann innerhalb von <code>_ready()</code> zu initialisieren. Ein essentieller Unterschied ist, dass wir für die Validierung ausschließlich den öffentlichen Schlüssel benötigen und dies daher beim Laden des Schlüssels (Zeile 10) als zweiten Parameter angeben müssen. Diesen Schlüssel hinterlegen wir in unserer <code>JWTAlgorithm</code>-Variable als <code>_public_crypto</code> und setzen natürlich identisch zum Authentication-Server <code>JWTAlgorithm.Type.RSA256</code> als Algorithmus.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>var</span> jwt_algorithm: JWTAlgorithm
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#66d9ef>var</span> public_key :<span style=color:#f92672>=</span> CryptoKey<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#66d9ef>var</span> load_ret :<span style=color:#f92672>=</span> public_key<span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;res://crypto/jwt_rsa.pem&#34;</span>, true)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#66d9ef>if</span> load_ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>		jwt_algorithm <span style=color:#f92672>=</span> JWTAlgorithm<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		jwt_algorithm<span style=color:#f92672>.</span>_public_crypto <span style=color:#f92672>=</span> public_key
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		jwt_algorithm<span style=color:#f92672>.</span>_alg <span style=color:#f92672>=</span> JWTAlgorithm<span style=color:#f92672>.</span>Type<span style=color:#f92672>.</span>RSA256
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		print(<span style=color:#e6db74>&#34;Error while reading RSA public key: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> load_ret)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		get_tree()<span style=color:#f92672>.</span>quit(load_ret)</span></span></code></pre></div><p>Die Überprüfung der Tokens findet innerhalb von <code>s_login_request</code> statt. Dafür erzeugen wir mit Hilfe des Tokens einen <code>JWTDecoder</code> (Zeile 45) und verifizieren anschließend mit Hilfe des in <code>_ready()</code> initialisierten <code>JWTAlgorithm</code> (Zeile 46) die Signatur. Danach stellen wir sicher, dass der Token auch noch gültig ist (Zeile 47). Sollte der Token sowohl über eine gültige Signatur verfügen als auch noch gültig sein, senden wir ein positives Ergebnis an den Client zurück. Falls einer der Tests negativ ausgefallen ist, senden wir zuerst eine negative Antwort an den Client und trennen anschließend die Verbindung.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#66d9ef>func</span> s_login_request(token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#66d9ef>var</span> now :<span style=color:#f92672>=</span> <span style=color:#a6e22e>int</span>(Time<span style=color:#f92672>.</span>get_unix_time_from_system())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#66d9ef>var</span> user_id :<span style=color:#f92672>=</span> get_multiplayer()<span style=color:#f92672>.</span>get_remote_sender_id()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#66d9ef>var</span> jwt :<span style=color:#f92672>=</span> JWTDecoder<span style=color:#f92672>.</span>new(token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#66d9ef>var</span> is_signature_valid :<span style=color:#f92672>=</span> jwt_algorithm<span style=color:#f92672>.</span>verify(jwt)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	<span style=color:#66d9ef>var</span> is_unexpired <span style=color:#f92672>=</span> now <span style=color:#f92672>&lt;=</span> jwt<span style=color:#f92672>.</span>get_expires_at()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	<span style=color:#66d9ef>if</span> is_signature_valid <span style=color:#f92672>and</span> is_unexpired:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>		c_login_response<span style=color:#f92672>.</span>rpc_id(user_id, true)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>		c_login_response<span style=color:#f92672>.</span>rpc_id(user_id, false)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>		disconnect_player(user_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#66d9ef>func</span> c_login_response(_result: <span style=color:#a6e22e>bool</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>	<span style=color:#66d9ef>pass</span> <span style=color:#75715e># on game client</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#66d9ef>func</span> disconnect_player(user_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>	get_multiplayer()<span style=color:#f92672>.</span>disconnect_peer(user_id)</span></span></code></pre></div><p>Damit ist nun (endlich) unser Loginvorgang vollständig und unser Game-Client hat eine authentifizierte Verbindung zum World-Server aufgebaut, ohne dass der World-Server über Passwörter verfügen muss.</p><h3 class="title is-4" id=erlangen-von-verbindungsinformationen>Erlangen von Verbindungsinformationen</h3><p>Zum Ausklang dieses Tutorials möchte ich noch über eine weitere Neuerung von Godot 4 sprechen: &ldquo;Lower-level ENet&rdquo;. <a href=http://enet.bespin.org/ target=_blank rel="noopener nofollow noreferrer">ENet</a> hat auch neben der reinen Netzwerkkommunikation noch einige interessante Features, die sehr nützlich sein können. Beispielsweise hat man bei ENet eigentlich eine direkte Möglichkeit, die &ldquo;Round-Trip-Time&rdquo; (RTT) einer Verbindung abzufragen. Nur bis Godot 4 war ENet so gekapselt, dass man innerhalb von GDScript keinen Zugriff auf diese Informationen hatte. Daher freut es mich, dass neben den unglaublich vielen anderen Änderungen in Godot 4 auch dies <a href=https://github.com/godotengine/godot/pull/50710 target=_blank rel="noopener nofollow noreferrer">geändert</a> wurde. Somit existieren nun mit <a href=https://docs.godotengine.org/en/stable/classes/class_enetconnection.html target=_blank rel="noopener nofollow noreferrer"><code>ENetConnection</code></a> und <a href=https://docs.godotengine.org/en/stable/classes/class_enetpacketpeer.html target=_blank rel="noopener nofollow noreferrer"><code>ENetPacketPeer</code></a> Wrapper, die Zugriff auf die eigentliche ENet-Funktionalität bieten. <a href=https://github.com/Faless target=_blank rel="noopener nofollow noreferrer">Fabio Alessandrelli (Faless)</a> hat dazu auch einen eigenen lesenswerten <a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-3/ target=_blank rel="noopener nofollow noreferrer">Blogpost als Progress Report</a> auf der Godot-Seite verfasst.</p><p>Um diese neuen Möglichkeiten auszutesten, wäre es vielleicht eine gute Idee, den Game-Client so zu erweitern, dass er regelmäßig die RTT in Richtung World-Server ausgibt. Dafür erweitern wir zuerst <code>./scenes/network/world_server.gd</code> um eine neue Skriptvariable, in der wir uns unser <code>ENetPacketPeer</code>-Objekt speichern:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#66d9ef>var</span> peer : ENetPacketPeer <span style=color:#f92672>=</span> null</span></span></code></pre></div><p>Da der Game-Client als Netzwerkclient nur mit dem World-Server in Verbindung steht, kennt er nur einen Peer. Daher ist es meiner bescheidenen Meinung nach am einfachsten, an das passende Objekt zu kommen, indem wir uns über unser <code>ENetMultiplayerPeer</code>-Objekt Zugriff auf die zugehörige <code>ENetConnection</code> verschaffen, bei der wir uns dann den ersten (und einzigen) <code>ENetPacketPeer</code> abgreifen (Zeile 46).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#66d9ef>func</span> c_login_response(result: <span style=color:#a6e22e>bool</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	print(<span style=color:#e6db74>&#34;login request result is </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> str(result))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>disconnect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#66d9ef>if</span> result:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>		peer <span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>get_host()<span style=color:#f92672>.</span>get_peers()[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	callback<span style=color:#f92672>.</span>call(OK <span style=color:#66d9ef>if</span> result <span style=color:#66d9ef>else</span> ERR_INVALID_DATA)</span></span></code></pre></div><p>So können wir anschließend jederzeit <a href=https://docs.godotengine.org/en/stable/classes/class_enetpacketpeer.html#class-enetpacketpeer-method-get-statistic target=_blank rel="noopener nofollow noreferrer"><code>get_statistic()</code></a> auf unserer Netzwerkverbindung aufrufen und beispielsweise eine Funktion zur Abfrage der durchschnittlichen RTT zur Verfügung stellen:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#66d9ef>func</span> get_rtt() <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>float</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	<span style=color:#66d9ef>if</span> peer:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>		<span style=color:#66d9ef>return</span> peer<span style=color:#f92672>.</span>get_statistic(ENetPacketPeer<span style=color:#f92672>.</span>PEER_ROUND_TRIP_TIME)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span></span></span></code></pre></div><p>Jetzt müssen wir nur noch unser Skript zur Main-Szene <code>./scenes/main.gd</code> etwas erweitern. Zuerst fügen wir eine Variable für einen Timer hinzu:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#66d9ef>var</span> rtt_timer : <span style=color:#a6e22e>Timer</span></span></span></code></pre></div><p>Und dann erweitern wir noch <code>_world_server_callback()</code>. Sollten wir einen erfolgreichen Verbindungsaufbau zum World-Server geschafft haben, erzeugen wir einen neuen Timer, fügen ihn dem <code>SceneTree</code> hinzu, verknüpfen das <code>timeout</code>-Signal des Timers und starten diesen mit einem Intervall von 5 Sekunden. In der Funktion, die nun durch das <code>timeout</code>-Signal des Timers aufgerufen wird, fragen wir unsere RTT ab.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#66d9ef>func</span> _world_server_callback(return_code: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>		print(<span style=color:#e6db74>&#34;Login to world server was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>		rtt_timer <span style=color:#f92672>=</span> <span style=color:#a6e22e>Timer</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>		add_child(rtt_timer)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>		rtt_timer<span style=color:#f92672>.</span>timeout<span style=color:#f92672>.</span>connect(_on_rtt_timer_timeout)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>		rtt_timer<span style=color:#f92672>.</span>start(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>		<span style=color:#75715e># Add further game logic</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>		gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>		gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>		print(<span style=color:#e6db74>&#34;Login to world server failed&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#66d9ef>func</span> _on_rtt_timer_timeout() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>	<span style=color:#66d9ef>if</span> world_server:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>		print(<span style=color:#e6db74>&#34;RTT: </span><span style=color:#e6db74>%f</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> world_server<span style=color:#f92672>.</span>get_rtt())</span></span></code></pre></div><div class="message is-info"><div class=message-body>Man darf sich über die relativ hohen Werte ~15-20ms für die RTT bei lokalen Tests nicht wundern. Das klingt zwar im ersten Moment hoch, da die Verbindung ja lokal ist, aber man muss bedenken, dass die RTT nicht nur Hin- und Rückweg beinhaltet, was ja lokal entfällt, sondern auch die Verarbeitungszeit auf dem Server beinhaltet.</div></div><h3 class="title is-4" id=der-nächste-schritt>Der nächste Schritt</h3><p>Bevor wir anfangen werden, Spielercharaktere zu spawnen oder aktiv Nachrichten zwischen Game-Client und World-Server auszutauschen, was alles vorgemerkte Themen für diese Tutorialserie sind, werden wir uns im nächsten Tutorial mit <a href=https://de.wikipedia.org/wiki/Datagram_Transport_Layer_Security target=_blank rel="noopener nofollow noreferrer">DTLS</a> beschäftigen. Wir kümmern uns also darum, die Netzwerkverbindungen zwischen allen Kommunikationspartnern zu verschlüsseln, um einerseits vom Game-Client verschickte Passwörter zu schützen und andererseits das &ldquo;Einhacken&rdquo; von bspw. Cheat-Software zu erschweren.</p></div></article><footer class=columns><div class="column has-text-left"><a href=/de/blog/2023/network-tutorial-4-login-2/ class="button right"><span class=icon-text><span class=icon><i class="fa fa-angle-left"></i></span><span>Netzwerktutorial 4: Login 2 - Gateway- und Authentication-Server</span></span></a></div><div class="column has-text-right"><a href=/de/blog/2023/network-tutorial-6-dtls/ class="button left"><span class=icon-text><span>Netzwerktutorial 6: Verschlüsselte Verbindungen mit Hilfe von DTLS</span><span class=icon><i class="fa fa-angle-right"></i></span></span></a></div></footer></div></div></div></section><footer class=footer><div class="container is-fluid has-text-centered"><ul class=socnet-icons><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-ca6abdddf7></span>
<script id=cloaked-script-ca6abdddf7>var cloakElement=document.getElementById("cloaked-ca6abdddf7"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></ul><p class=copyright><a href=https://www.somethinglikegames.de/de/legal_notice/>Impressum</a> &mdash;
<a href=https://www.somethinglikegames.de/de/privacy_policy/>Datenschutzerklärung</a> &mdash;
©2023 Tobias Wink<br>Powered by <a href=https://gohugo.io/ title=0.109.0 target=_blank rel=noopener>Hugo</a></p></div></footer><script src=/js/navbar.min.js defer></script>
<script src=/js/copy-code-button.min.js defer></script></body></html>