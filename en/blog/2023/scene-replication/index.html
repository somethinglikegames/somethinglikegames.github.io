<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/sass/main.min.f6d044b67731fc418190a304668c848b0e240406fe652d5b63b8b82680bf6950585f1957e5bdc647161ed8b86a2ba218f28847056ae8f4c6c5d98d990c42f613.css integrity="sha512-9tBEtncx/EGBkKMEZoyEiw4kBAb+ZS1bY7i4JoC/aVBYXxlX5b3GRxYe2LhqK6IY8ohHBWro9MbF2Y2ZDEL2Ew=="><link rel=stylesheet href=/css/all.min.a0921f068fa9017ba1288b77420fbde17d89619431fab12b4d996e3e124af17337ac1b80bc2bb62458509e6033ace757405b5881b0c1d0db837dd64c8783b607.css integrity="sha512-oJIfBo+pAXuhKIt3Qg+94X2JYZQx+rErTZluPhJK8XM3rBuAvCu2JFhQnmAzrOdXQFtYgbDB0NuDfdZMh4O2Bw=="><title>Something Like Games | Scene Replication with Godot 4(.1)</title><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=description content="This tutorial is about the integration of 'Scene Replication' so that objects and/or property changes are automatically replicated to all network participants."><meta itemprop=description content="This tutorial is about the integration of 'Scene Replication' so that objects and/or property changes are automatically replicated to all network participants."><meta name=twitter:description content="This tutorial is about the integration of 'Scene Replication' so that objects and/or property changes are automatically replicated to all network participants."><meta property="twitter:image" content="https://www.somethinglikegames.de/images/blog/2023/scene-replication/intro.webp"><meta property="og:description" content="This tutorial is about the integration of 'Scene Replication' so that objects and/or property changes are automatically replicated to all network participants."><meta property="og:image" content="https://www.somethinglikegames.de/images/blog/2023/scene-replication/intro.webp"></head><body><nav class="navbar is-light" role=navigation aria-label="main navigation"><div class=navbar-brand><a href=/en/ class=navbar-item><img src=/images/brand.webp alt="Something Like Games" width=128px height=28></a>
<a role=checkbox class=navbar-burger aria-label=menu aria-expanded=false data-target=navigation><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=navigation class=navbar-menu><div class=navbar-end><div class=navbar-item><a href=/en/ class="nav link icon-text"><span class=icon><i class='fa fa-home'></i></span><span>Home</span></a></div><div class=navbar-item><a href=/en/contact/ class="nav link icon-text"><span class=icon><i class='fa fa-mail-bulk'></i></span><span>Contact</span></a></div><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link href=#>English (en)</a><div class="navbar-dropdown is-right"><a href=https://www.somethinglikegames.de/de/blog/2023/scene-replication/ lang=de class=navbar-item>Deutsch (de)</a></div></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-one-fifth"><section id=site-sidebar class=is-hidden-mobile><section id=site-intro class="block has-text-centered"><a href=/en/><img src=/images/logo.webp class=circle width=128px height=128px alt=somethinglikegames.de></a><header></header><main><p>My personal Blog about Game Development as a single person in part time</p></main><footer class="footer has-no-background"><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-0e924f5b35></span>
<script id=cloaked-script-0e924f5b35>var cloakElement=document.getElementById("cloaked-0e924f5b35"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></footer></section><div class=block><hr></div><section id=categories class="block categories"><header><h1><a href=/en/categories><span class=icon-text><span class=icon><i class="fa fa-folders"></i></span><span>Categories</span></span></a></h1></header><ul><li><a href=/en/categories/tutorials/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>tutorials</span></span><span class=count>9</span></a><li><a href=/en/categories/misc/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>misc</span></span><span class=count>5</span></a><li><a href=/en/categories/news/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>news</span></span><span class=count>2</span></a></li></ul></section></section></div><div class=column><article class=card><div class=card-image><a href=/en/blog/2023/scene-replication/ class=cover-image style="--bg-image:url('https://www.somethinglikegames.de/images/blog/2023/scene-replication/intro.webp')"><img class=stretchV src=https://www.somethinglikegames.de/images/blog/2023/scene-replication/intro.webp alt="A cute and tiny robot with big eyes interacts with a machine to make a clone of himself. The machine has a camera to replicate the robot."></a><div class=copyright><a href=https://huggingface.co/spaces/stabilityai/stable-diffusion class=has-text-grey target=_blank rel="noopener nofollow noreferrer">Generated with Stable Diffusion 2.1</a></div></div><header class=card-header><div class=card-header-title><h2 class=title><a href=/en/blog/2023/scene-replication/>Scene Replication with Godot 4(.1)</a></h2></div></header><div class="card-content is-size-5 content"><div class=columns><div class=column><time datetime="2023-07-11 18:40:00 +0100 +0100">July 11, 2023</time></div></div><div class=columns><div class=column><div class=tags><span class="tag is-info is-light"><a href=/en/categories/tutorials/ class=has-text-info><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span>
<span>Tutorials</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/godot-engine/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Godot Engine</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/networking/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking</span></span></a></span></div></div></div><p>For this article I would like to apologize in advance that the positions of text and images are not always quite coherent. Unfortunately I couldn&rsquo;t think of a better positioning, but I hope you can cope with it. After the <a href=/en/tags/networking-tutorial/>tutorial series</a>, which offers a good basic framework, today&rsquo;s tutorial is about a topic that you can really see. The example shown here is based on a <a href=https://godotengine.org/article/multiplayer-in-godot-4-0-scene-replication/ target=_blank rel="noopener nofollow noreferrer">blog post</a> by Fabio Alessandrelli, one of the main developers for the Godot network functionality. And since I don&rsquo;t want to just copy everything, here&rsquo;s how you can also use the techniques shown there when using path-dependent <a href=https://docs.godotengine.org/en/stable/classes/class_multiplayerapi.html#class-multiplayerapi target=_blank rel="noopener nofollow noreferrer">MultiplayerAPIs</a>.</p><div class="message is-info"><div class=message-body>To follow this tutorial, you don&rsquo;t necessarily need the project from my <a href=/en/tags/networking-tutorial/>tutorial series</a>, but it doesn&rsquo;t hurt either 😉. You can find the previous Godot projects in the associated <a href=https://github.com/somethinglikegames/godot4-network-tutorial/tree/network-tutorial-6-dtls target=_blank rel="noopener nofollow noreferrer">Github repository</a>. Alternatively, it is sufficient to have a Godot project that can already establish a network connection between client and server.</div></div><p>Today we want to deal with <em>Scene Replication</em>. With this term one describes the task of sending the current game scenery, thus for example level, player positions, etc., to all connected GameClients. In this way, an attempt is made to provide all GameClients with an (as far as possible) identical picture of the current game events. There are, as so often, different approaches to this. To keep the cheating potential as low as possible, network games should always use authoritative servers. This means that the GameClient is &ldquo;dumb&rdquo; and only registers inputs, sends them to the server and otherwise displays the game scenery transmitted by the server. All calculations regarding position changes, actions and their effects etc. are done by the server.</p><div class="message is-info"><div class=message-body>In today&rsquo;s time this is no longer completely true, since one tries nowadays to compensate the latency, which arises by the network communication necessarily, by having certain computations additionally executed by the GameClient. However, the calculations of the GameClient are still overwritten by the respective results of the server, as soon as the network packets arrive. The topic of lag compensation is very complex and will perhaps be discussed in more detail in a later article.</div></div><p>Godot 4 provides two new high-level components that allow us to perform <em>Scene Replication</em> without having to worry about the underlying RPC communication:</p><dl><dt><a href=https://docs.godotengine.org/en/stable/classes/class_multiplayersynchronizer.html target=_blank rel="noopener nofollow noreferrer">MultiplayerSynchronizer</a></dt><dd>Synchronizes specified properties (e.g. position data) between network participants. The default value for the synchronization interval is variable and corresponds to the current game FPS. So if you want to have a fixed tick rate like in many first person shooters (e.g. Counter-Strike: Global Offensive) you have to configure this via &ldquo;Replication Interval&rdquo; on each <code>MultiplayerSynchronizer</code> or centrally in the project settings.</dd><dt><a href=https://docs.godotengine.org/en/stable/classes/class_multiplayerspawner.html target=_blank rel="noopener nofollow noreferrer">MultiplayerSpawner</a></dt><dd>Replicates spawnable nodes from the network authority, in our case the server, to the other network participants, in our case all clients.</dd></dl><p>As an example, throughout the article, the GameClient and WorldServer will be extended so that a game character appears for each connected GameClient and can be controlled by the associated GameClient. To keep the example as simple as possible, the control is based on the &ldquo;Basic Movement&rdquo; template of <code>CharacterBody3D</code>, so that the characters can move left, right, forward and backward and also jump.</p><p>But before we really start, the following result video should motivate a bit:</p><video controls autoplay>
<source src=/images/blog/2023/scene-replication/scene_replication_in_action.webm type=video/webm>Your browser does not support the video tag.</video><h3 class="title is-4" id=the-player-scene>The Player scene</h3><figure class="title is-6 is-pulled-left"><img src=/images/blog/2023/scene-replication/player_scene_world_server.webp alt="Structure of the Player scene"><figcaption><h4>Structure of the Player scene</h4></figcaption></figure><p>The player scene, as you can see in the accompanying screenshot, is actually quite simple in structure. Our top node is a <code>CharacterBody3D</code>, as is probably the case in every 3D Godot project for the player character. Accordingly there are as children, as felt in every second example, a <code>CollisionShape3D</code> with <code>CapsuleShape3D</code> as <code>Shape</code> and a <code>MeshInstance3D</code> with <code>CapsuleMesh</code> as <code>Mesh</code>. Almost all default settings are left, only as <code>position</code>, below Transform, we use (0, 1, 0) as vector, so that nothing hangs in the ground. Additionally there is a <code>Camera3D</code>, which serves as the player camera. The exact values of the camera are not so important for the tutorial, you should only be able to see something of the environment next to the player character. The player scene exists in the GameClient as well as in the WorldServer, just like the respective scripts.</p><figure class="title is-6 is-pulled-right"><img src=/images/blog/2023/scene-replication/player_input_inspector.webp alt="PlayerInput configuration"><figcaption><h4>PlayerInput configuration</h4></figcaption></figure><p>Next, let&rsquo;s look at the two <em>new</em> nodes &ldquo;ServerSynchronizer&rdquo; and &ldquo;PlayerInput&rdquo;. These are nodes of the type <code>MultiplayerSynchronizer</code>, and they take over the synchronization of properties from us. It can be determined for each <code>MultiplayerSynchronizer</code> individually whether one would like to use e.g. a deviating synchronization interval.</p><h4 class="title is-5" id=the-playerinput-node>The PlayerInput Node</h4><p>The task of &ldquo;PlayerInput&rdquo; is to intercept the input of the respective player in the GameClient to send it to the server. This can be seen in the properties of <code>PlayerInput.gd</code>, which we will have a closer look at in the script. The <code>RootPath</code> is <code>PlayerInput</code>, because the GameClient should only be allowed to send input data within (and below) this node, since the results should be calculated by the server.</p><p>As you can see in the screenshot of the corresponding replication tab, a property called <code>direction</code> is synchronized via <code>Sync</code>. This property contains the input vector of the player or GameClient and should be used by the server to calculate the speed and the position.</p><figure class="title is-6 center"><img src=/images/blog/2023/scene-replication/player_input_properties.webp alt="Replication tab of PlayerInput"><figcaption><h4>Replication tab of PlayerInput</h4></figcaption></figure><p>In general, with <code>Spawn</code>, <code>Sync</code> and <code>Watch</code> you have three possible settings to influence the synchronization. <code>Spawn</code> synchronizes the property directly at spawning, i.e. during the insertion of the node into the scene. Sync synchronizes the property at the configured interval. Watch synchronizes the property reliably at the configured interval if the property has changed.</p><div class="message is-info"><div class=message-body>Watch&rsquo; is still very fresh and was only added with Godot 4.1. From the description it sounds like the better alternative to <code>Sync</code>, because it only synchronizes when something has changed. I did it with <code>Sync</code> because on the one hand I had finished and tested the example for this article before Godot 4.1 and on the other hand I wanted to orientate myself on the <a href=https://godotengine.org/article/multiplayer-in-godot-4-0-scene-replication/ target=_blank rel="noopener nofollow noreferrer">blog post</a> of Fabio Alessandrelli.</div></div><p>Now we come to the associated script <code>player_input.gd</code>. As mentioned before, all possible player inputs are read there and then sent to the server. For the intended input possibilities the two variables <code>jumping</code> and <code>direction</code> are sufficient. <code>jumping</code> indicates whether the player should jump, and <code>direction</code> as <code>Vector2</code> contains the direction of the player&rsquo;s movement.</p><p>In line 8 within the <code>_ready()</code> function it is determined whether the &ldquo;PlayerInput&rdquo; node should be active or not. Of course, the node should only be active if it is the <code>PlayerInput</code> node of the active GameClient, because otherwise you would control all other game characters at the same time as well. Within the <code>_process()</code> function we determine the input for <code>direction</code>, for this we use the function <code>Input.get_vector()</code> to get the appropriate <code>Vector2</code> value directly. The jump input is realized by calling the <code>jump()</code> function as RPC, which is not only executed on the server but also locally thanks to <code>@rpc("call_local")</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> MultiplayerSynchronizer
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>var</span> jumping :<span style=color:#f92672>=</span> false
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>var</span> direction :<span style=color:#f92672>=</span> <span style=color:#a6e22e>Vector2</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	set_process(get_multiplayer_authority() <span style=color:#f92672>==</span> multiplayer<span style=color:#f92672>.</span>get_unique_id())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#66d9ef>func</span> _process(delta: <span style=color:#a6e22e>float</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	direction <span style=color:#f92672>=</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span>get_vector(<span style=color:#e6db74>&#34;ui_left&#34;</span>, <span style=color:#e6db74>&#34;ui_right&#34;</span>, <span style=color:#e6db74>&#34;ui_up&#34;</span>, <span style=color:#e6db74>&#34;ui_down&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>Input</span><span style=color:#f92672>.</span>is_action_just_pressed(<span style=color:#e6db74>&#34;ui_accept&#34;</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		jump<span style=color:#f92672>.</span>rpc()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_local&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#66d9ef>func</span> jump():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	jumping <span style=color:#f92672>=</span> true</span></span></code></pre></div><h4 class="title is-5" id=the-player-script>The Player Script</h4><p>After looking at how the input data is collected and sent to the server, let&rsquo;s look at its processing in the <code>player.gd</code> script attached to our main <code>player</code> node. The property declaration should look pretty ordinary, except for the <code>player</code> property or the associated setter. This value is set by the server when it is created, and then in the setter we set the passed ID as <code>MultiplayerAuthority</code> for our <code>PlayerInput</code> node. This allows us, as shown in the previous section, to make the check in the <code>_ready()</code> function of the <code>PlayerInput</code> node whether the script should be executed or not.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> CharacterBody3D
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>const</span> SPEED <span style=color:#f92672>=</span> <span style=color:#ae81ff>5.0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>const</span> JUMP_VELOCITY <span style=color:#f92672>=</span> <span style=color:#ae81ff>4.5</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#75715e># Get the gravity from the project settings to be synced with RigidBody nodes.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>var</span> gravity: <span style=color:#a6e22e>float</span> <span style=color:#f92672>=</span> ProjectSettings<span style=color:#f92672>.</span>get_setting(<span style=color:#e6db74>&#34;physics/3d/default_gravity&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#75715e># Set by server (authority), synchronized on spawn</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>var</span> player :<span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	set(id):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		player <span style=color:#f92672>=</span> id
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		<span style=color:#f92672>$</span>PlayerInput<span style=color:#f92672>.</span>set_multiplayer_authority(id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> input <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>PlayerInput</span></span></code></pre></div><p>In the <code>_ready()</code> function we check if the GameClient is responsible for the game character. If it is responsible, we set <code>Camera3D</code> as the current camera.</p><p>Within <code>_physics_process()</code> the processing of the input data takes place as usual, only that these do not have to be determined first, but are already prepared thanks to the <code>MultiplayerSynchronizer</code> in <code>input.direction</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#66d9ef>if</span> player <span style=color:#f92672>==</span> multiplayer<span style=color:#f92672>.</span>get_unique_id():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		<span style=color:#f92672>$</span>Camera3D<span style=color:#f92672>.</span>current <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#66d9ef>func</span> _physics_process(delta: <span style=color:#a6e22e>float</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	<span style=color:#75715e># Add the gravity.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_on_floor():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		velocity<span style=color:#f92672>.</span>y <span style=color:#f92672>-=</span> gravity <span style=color:#f92672>*</span> delta
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	<span style=color:#75715e># Handle Jump.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#66d9ef>if</span> input<span style=color:#f92672>.</span>jumping <span style=color:#f92672>and</span> is_on_floor():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>		velocity<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> JUMP_VELOCITY
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	input<span style=color:#f92672>.</span>jumping <span style=color:#f92672>=</span> false
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	<span style=color:#66d9ef>var</span> direction :<span style=color:#f92672>=</span> (transform<span style=color:#f92672>.</span>basis <span style=color:#f92672>*</span> <span style=color:#a6e22e>Vector3</span>(input<span style=color:#f92672>.</span>direction<span style=color:#f92672>.</span>x, <span style=color:#ae81ff>0</span>, input<span style=color:#f92672>.</span>direction<span style=color:#f92672>.</span>y))<span style=color:#f92672>.</span>normalized()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#66d9ef>if</span> direction:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>		velocity<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> direction<span style=color:#f92672>.</span>x <span style=color:#f92672>*</span> SPEED
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		velocity<span style=color:#f92672>.</span>z <span style=color:#f92672>=</span> direction<span style=color:#f92672>.</span>z <span style=color:#f92672>*</span> SPEED
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>		velocity<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> move_toward(velocity<span style=color:#f92672>.</span>x, <span style=color:#ae81ff>0</span>, SPEED)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>		velocity<span style=color:#f92672>.</span>z <span style=color:#f92672>=</span> move_toward(velocity<span style=color:#f92672>.</span>z, <span style=color:#ae81ff>0</span>, SPEED)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>	move_and_slide()</span></span></code></pre></div><h4 class="title is-5" id=the-serversynchronizer-node>The ServerSynchronizer Node</h4><figure class="title is-6 is-pulled-right"><img src=/images/blog/2023/scene-replication/server_synchronizer_inspector.webp alt="ServerSynchronizer configuration"><figcaption><h4>ServerSynchronizer configuration</h4></figcaption></figure><p>Now that the actual movement of the game character has taken place in the player script, the relevant result data must be replicated from the server to all connected GameClients. We do this with the help of the &ldquo;ServerSynchronizer&rdquo;. Since this synchronizer works directly with the properties of our player node, the player node is also stored as <code>Root Path</code>. All other options remain at their default values. As you can see in the following screenshot of the corresponding replication tab, three values are transmitted using this node: <code>player</code>, <code>position</code> and <code>velocity</code>.</p><p><code>player</code> is the unique multiplayer ID of the GameClient, which is assigned by the server as soon as a new player is spawned. <code>position</code> and <code>velocity</code> are the well-known <code>Vector3</code> values from <a href=https://docs.godotengine.org/en/stable/classes/class_node3d.html target=_blank rel="noopener nofollow noreferrer"><code>Node3D</code></a> and <a href=https://docs.godotengine.org/en/stable/classes/class_characterbody3d.html target=_blank rel="noopener nofollow noreferrer"><code>CharacterBody3D</code></a> respectively, which contain the current position and the current velocity. Both position and velocity are to be synchronized not only at node creation (during spawn), but also periodically at runtime.</p><figure class="title is-6 center"><img src=/images/blog/2023/scene-replication/server_synchronizer_properties.webp alt="Replication tab of ServerSynchronizer"><figcaption><h4>Replication tab of ServerSynchronizer</h4></figcaption></figure><p>This concludes the discussion of the player scene so far. Our game is now able to collect input data on the GameClients at runtime, process them on the server and then send the relevant result data back to the GameClients. The only problem is, how do the respective instances of the player scene get into the game?</p><h3 class="title is-4" id=the-level-scene>The Level scene</h3><figure class="title is-6 is-pulled-left"><img src=/images/blog/2023/scene-replication/level_scene_world_server.webp alt="Structure of the Level scene"><figcaption><h4>Structure of the Level scene</h4></figcaption></figure><p>In the accompanying screenshot you can see the structure of my level scene. It is kept as simple as possible, so that we can concentrate on the essentials. Therefore there is only one floor, which has a <a href=https://docs.godotengine.org/en/stable/classes/class_planemesh.html#class-planemesh target=_blank rel="noopener nofollow noreferrer"><code>PlaneMesh</code></a> with 25mx25m as <code>MeshInstance3D</code> as child. The other child <code>CollisionShape3D</code> is a <a href=https://docs.godotengine.org/en/stable/classes/class_worldboundaryshape3d.html target=_blank rel="noopener nofollow noreferrer"><code>WorldBoundaryShape3D</code></a>, so no GameClient can fall down anywhere. The <code>OmniLight3D</code> provides some light, the exact values are not important for this example. The <code>Objects</code> and <code>Players</code> are empty containers, where objects or game characters should be spawned into. Last but not least there is the <code>PlayerSpawner</code>. This is the second high-level component <code>MultiplayerSpawner</code> for scene replication. This <code>PlayerSpawner</code> is responsible for the fact that all GameClients notice it, if a new game character is spawned. To achieve this, the <code>PlayerSpawner</code> must first be configured correctly.</p><figure class="title is-6 is-pulled-right"><img src=/images/blog/2023/scene-replication/multiplayer_spawner_inspector.webp alt="PlayerSpawner configuration"><figcaption><h4>PlayerSpawner configuration</h4></figcaption></figure><p>As we can see in the accompanying screenshot of the Inspector from the <code>PlayerSpawner</code> node, there are two properties that we need to adjust in order to achieve the desired result. First, the <code>Spawn Path</code> must be set to the <code>Players</code> node. This configuration has the effect that now the <code>Players</code> node is monitored. As soon as an instance of an element of the <code>Auto Spawn List</code> appears as a direct child of the <code>Players</code> node, this is communicated to all GameClients, so that the <code>PlayerSpawner</code> nodes there can also create a suitably instantiated child node. So now, in order for our spawner to replicate instances of the player scene, this scene must be added to the <code>Auto Spawn List</code>.</p><p>The structure of the level scene is (almost) identical on the GameClient and the WorldServer. The WorldServer additionally has an active script that controls the addition and removal of game characters when GameClients connect or disconnect. For this purpose, in the associated <code>_ready()</code> function, the <code>add_player()</code> and <code>del_player()</code> functions are connected to the associated signals. In <code>_exit_tree()</code> we clean up 😉 of course and stop eavesdropping on the signals.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> Node3D
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>const</span> SPAWN_RANDOM :<span style=color:#f92672>=</span> <span style=color:#ae81ff>5.0</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> players :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Players
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#66d9ef>for</span> id <span style=color:#f92672>in</span> multiplayer<span style=color:#f92672>.</span>get_peers():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		add_player(id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	get_multiplayer()<span style=color:#f92672>.</span>peer_connected<span style=color:#f92672>.</span>connect(add_player)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	get_multiplayer()<span style=color:#f92672>.</span>peer_disconnected<span style=color:#f92672>.</span>connect(del_player)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#66d9ef>func</span> _exit_tree():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	get_multiplayer()<span style=color:#f92672>.</span>peer_connected<span style=color:#f92672>.</span>disconnect(add_player)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	get_multiplayer()<span style=color:#f92672>.</span>peer_disconnected<span style=color:#f92672>.</span>disconnect(del_player)</span></span></code></pre></div><p>The function <code>add_player()</code> has the task of instantiating the player scene appropriately and then adding it to the <code>players</code> node as a direct child. To do this, we first instantiate the actual player scene, of course, and store the passed network ID of the associated GameClient in the <code>player</code> property. Then, using some random magic, we create a starting position, name the node after the network ID, and add it to the <code>players</code> node.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#66d9ef>func</span> add_player(id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>	<span style=color:#66d9ef>var</span> character :<span style=color:#f92672>=</span> preload(<span style=color:#e6db74>&#34;res://scenes/levels/player.tscn&#34;</span>)<span style=color:#f92672>.</span>instantiate()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>	character<span style=color:#f92672>.</span>player <span style=color:#f92672>=</span> id
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	<span style=color:#75715e># Randomize character position</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	<span style=color:#66d9ef>var</span> pos :<span style=color:#f92672>=</span> <span style=color:#a6e22e>Vector2</span><span style=color:#f92672>.</span>from_angle(randf() <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> PI)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	character<span style=color:#f92672>.</span>position <span style=color:#f92672>=</span> <span style=color:#a6e22e>Vector3</span>(pos<span style=color:#f92672>.</span>x <span style=color:#f92672>*</span> SPAWN_RANDOM <span style=color:#f92672>*</span> randf(), <span style=color:#ae81ff>0</span>, pos<span style=color:#f92672>.</span>y <span style=color:#f92672>*</span> SPAWN_RANDOM <span style=color:#f92672>*</span> randf())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	character<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> str(id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	players<span style=color:#f92672>.</span>add_child(character, true)</span></span></code></pre></div><p>Should a GameClient terminate the connection, the function <code>del_player()</code> is called. There it tests if there is a node below the <code>player</code> node with the name of the passed network ID. If so, it will be deleted.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#66d9ef>func</span> del_player(id: <span style=color:#a6e22e>int</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> players<span style=color:#f92672>.</span>has_node(str(id)):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	players<span style=color:#f92672>.</span>get_node(str(id))<span style=color:#f92672>.</span>queue_free()</span></span></code></pre></div><p>Thanks to properly configured <code>PlayerSpawner</code>, the added or removed player scene nodes below the <code>Players</code> node are automatically replicated to all GameClients. So now GameClients can connect/disconnect dynamically, and all other GameClients get this. Congratulations to all who have taken their own example project 👏 because now everything essential has been shown. To all others I also congratulate 👏, but am additionally pleased that we may now integrate everything still in the example project from the tutorial series.</p><h3 class="title is-4" id=integration-into-the-sample-project-from-the-tutorial-series>Integration into the sample project from the tutorial series</h3><p>To recap, the sample project from the <a href=/en/tags/networking-tutorial/>tutorial series</a> consists of a total of 4 components - AuthenticationServer, GatewayServer, WorldServer and GameClient. Authentication and GatewayServer are involved exclusively during login, which is already completed when a game character is to be created and linked to a GameClient. Therefore, we do not need to make any adjustments there and can continue to ignore them, as we have done so far in this article.</p><h3 class="title is-5" id=integration-into-the-worldserver>Integration into the WorldServer</h3><figure class="title is-6 is-pulled-left"><img src=/images/blog/2023/scene-replication/start_scene_world_server.webp alt="Structure of the Main scene"><figcaption><h4>Structure of the Main scene</h4></figcaption></figure><p>Let us first take care of the <code>Main</code> scene of the WorldServer. There the <code>WorldServer</code> node gets two children. Once <code>Level</code> as parent node of the level to be loaded. And then another node called <code>LevelSpawner</code>, which is of type <code>MultiplayerSpawner</code> and should replicate the loaded level. Therefore we select the sibling node <code>Level</code> as <code>Spawn Path</code>, set a <code>Spawn Limit</code> of 1, because we want to have a maximum of one level replicated and add our level scene to the <code>Auto Spawn List</code>. This limit is purely for security, since our script only instantiates one level scene.</p><p>The script <code>main.gd</code>, which belongs to the <code>Main</code> node, has to be slightly extended. The previous functionality, which configures the custom network path and starts the server, must now be adapted so that it loads our level scene as soon as the server is started.</p><figure class="title is-6 is-pulled-right"><img src=/images/blog/2023/scene-replication/level_spawner_inspector.webp alt="LevelSpawner configuration"><figcaption><h4>LevelSpawner configuration</h4></figcaption></figure><p>To achieve this, we create a new function <code>change_level()</code> (from line 14), which gets the scene to be loaded as parameter. To support different level scenes in the future and at the same time ensure that only one is active at a time, we delete possible other scenes or nodes below the <code>level</code> node. Then we add the instantiated scene to the <code>level</code> node as a child.</p><p>It is important that the scene is not loaded until the server is started. Otherwise, our <code>LevelSpawner</code> would already try to replicate the level, which would result in errors as long as no network connection is started. Therefore we link the call of <code>change_level()</code> with the signal <code>started</code> of our server. We bind the scene to be loaded directly to the <code>callable</code> of <code>change_level</code>.</p><p>Now only the signal <code>started</code> of our network server is missing, so that everything works smoothly. This is a signal which is emitted after the call of <code>create_server</code> if the return value is <code>OK</code>. In order not to worsen the clarity of this article even more, I have omitted these two lines. But of course you can find them in the corresponding <a href=https://github.com/somethinglikegames/godot4-network-tutorial/tree/scene-replication target=_blank rel="noopener nofollow noreferrer">Github repository</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> world_server :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>WorldServer
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> spawner :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>WorldServer<span style=color:#f92672>/</span>LevelSpawner
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>onready</span> <span style=color:#66d9ef>var</span> level :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>WorldServer<span style=color:#f92672>/</span>Level
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	get_tree()<span style=color:#f92672>.</span>set_multiplayer(SceneMultiplayer<span style=color:#f92672>.</span>new(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>		<span style=color:#f92672>^</span><span style=color:#e6db74>&#34;/root/Main/WorldServer&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	world_server<span style=color:#f92672>.</span>started<span style=color:#f92672>.</span>connect(change_level<span style=color:#f92672>.</span>bind(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		load(<span style=color:#e6db74>&#34;res://scenes/levels/level.tscn&#34;</span>)))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	world_server<span style=color:#f92672>.</span>startup()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#66d9ef>func</span> change_level(scene: <span style=color:#a6e22e>PackedScene</span>):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#75715e># Remove old level if any.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> level<span style=color:#f92672>.</span>get_children():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		level<span style=color:#f92672>.</span>remove_child(c)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		c<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#75715e># Add new level.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	level<span style=color:#f92672>.</span>add_child(scene<span style=color:#f92672>.</span>instantiate())</span></span></code></pre></div><h3 class="title is-5" id=integration-into-the-gameclient>Integration into the GameClient</h3><p>The challenge for the integration into the GameClient is to rebuild the structure of the main scene of the WorldServer in the GameClient after we have received a logintoken from the GatewayServer, but <strong>before</strong> we contact the WorldServer with the logintoken. For this reason, we need to extend the <code>_login_callback()</code> function in the <code>main.gd</code> script of the GameClient. To make the context easier to understand, I have displayed the entire function in the code block below and highlighted the new lines. The function is called when we received a response from the GatewayServer in the GameClient. If the response was positive, so we also got a login token, we want to contact the WorldServer. For this we create the <code>WorldServer</code> node, link the associated script, store a new instance of <code>MultiplayerAPI</code> for the <code>WorldServer</code> node and the necessary data or the callback.</p><p>Now comes the extension: We rebuild the structure of the main scene of the WorldServer. To do this, we have to add a <code>Node</code> called <code>Level</code> and a <code>MultiplayerSpawner</code> called <code>LevelSpawner</code> below the <code>WorldServer</code> node. Additionally, we need to configure our <code>LevelSpawner</code> appropriately (lines 20-22).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>func</span> _login_callback(return_code: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>		print(<span style=color:#e6db74>&#34;Current Token is: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>		world_server <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		world_server<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WorldServer&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		add_child(world_server)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>		world_server<span style=color:#f92672>.</span>set_script(load(<span style=color:#e6db74>&#34;res://scenes/network/world_server.gd&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		get_tree()<span style=color:#f92672>.</span>set_multiplayer(SceneMultiplayer<span style=color:#f92672>.</span>new(), <span style=color:#f92672>^</span><span style=color:#e6db74>&#34;/root/Main/WorldServer&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		world_server<span style=color:#f92672>.</span>world_server <span style=color:#f92672>=</span> world_server_data
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>		world_server<span style=color:#f92672>.</span>callback <span style=color:#f92672>=</span> _world_server_callback
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		<span style=color:#66d9ef>var</span> levelNode <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		levelNode<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Level&#34;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		world_server<span style=color:#f92672>.</span>add_child(levelNode)
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		<span style=color:#66d9ef>var</span> levelSpawner :<span style=color:#f92672>=</span> MultiplayerSpawner<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		levelSpawner<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LevelSpawner&#34;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		world_server<span style=color:#f92672>.</span>add_child(levelSpawner)
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		levelSpawner<span style=color:#f92672>.</span>spawn_path <span style=color:#f92672>=</span> levelNode<span style=color:#f92672>.</span>get_path()
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		levelSpawner<span style=color:#f92672>.</span>spawn_limit <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		levelSpawner<span style=color:#f92672>.</span>add_spawnable_scene(<span style=color:#e6db74>&#34;res://scenes/levels/level.tscn&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		world_server<span style=color:#f92672>.</span>login_to_server(token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	<span style=color:#66d9ef>else</span> :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>		print(<span style=color:#e6db74>&#34;Something went wrong…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>Once these changes are made, nothing should stand in the way of the test run. I hope I didn&rsquo;t forget anything and it was understandable so far. Otherwise you can find the finished project in the usual <a href=https://github.com/somethinglikegames/godot4-network-tutorial/tree/scene-replication target=_blank rel="noopener nofollow noreferrer">Github repository</a>.</p></div></article><footer class=columns><div class="column has-text-left"><a href=/en/blog/2023/a-small-interim-report/ class="button right"><span class=icon-text><span class=icon><i class="fa fa-angle-left"></i></span><span>A small interim report</span></span></a></div><div class="column has-text-right"><a href=/en/blog/2023/dtls-security-4.1/ class="button left"><span class=icon-text><span>DTLS security changes with Godot 4.1</span><span class=icon><i class="fa fa-angle-right"></i></span></span></a></div></footer></div></div></div></section><footer class=footer><div class="container is-fluid has-text-centered"><ul class=socnet-icons><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-cb2b79988a></span>
<script id=cloaked-script-cb2b79988a>var cloakElement=document.getElementById("cloaked-cb2b79988a"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></ul><p class=copyright><a href=https://www.somethinglikegames.de/en/legal_notice/>Legal Notice</a> &mdash;
<a href=https://www.somethinglikegames.de/en/privacy_policy/>Privacy Policy</a> &mdash;
©2023-2024 Tobias Wink<br>Powered by <a href=https://gohugo.io/ title=0.109.0 target=_blank rel=noopener>Hugo</a></p></div></footer><script src=/js/navbar.min.js defer></script>
<script src=/js/copy-code-button.min.js defer></script></body></html>