<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/sass/main.min.143551db89e311bf410f22e9ac4f1dd2496146fdc9f5bf27ac1a1839c6ce424fc8526487f0733de4c3e7617b55e897f6b91b57dd3abbf3e9ab4e1a59c1448e44.css integrity="sha512-FDVR24njEb9BDyLprE8d0klhRv3J9b8nrBoYOcbOQk/IUmSH8HM95MPnYXtV6Jf2uRtX3Tq78+mrThpZwUSORA=="><link rel=stylesheet href=/css/all.min.a0921f068fa9017ba1288b77420fbde17d89619431fab12b4d996e3e124af17337ac1b80bc2bb62458509e6033ace757405b5881b0c1d0db837dd64c8783b607.css integrity="sha512-oJIfBo+pAXuhKIt3Qg+94X2JYZQx+rErTZluPhJK8XM3rBuAvCu2JFhQnmAzrOdXQFtYgbDB0NuDfdZMh4O2Bw=="><title>Something Like Games | Networking tutorial 5: Login 3 - world server</title><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=description content="This part of the tutorial series deals with the third part of the login process. The client authenticates itself to the world server with the token of the authentication server."><meta itemprop=description content="This part of the tutorial series deals with the third part of the login process. The client authenticates itself to the world server with the token of the authentication server."><meta name=twitter:description content="This part of the tutorial series deals with the third part of the login process. The client authenticates itself to the world server with the token of the authentication server."><meta property="og:description" content="This part of the tutorial series deals with the third part of the login process. The client authenticates itself to the world server with the token of the authentication server."></head><body><nav class="navbar is-light" role=navigation aria-label="main navigation"><div class=navbar-brand><a href=/en/ class=navbar-item><img src=/images/brand.webp alt="Something Like Games" width=128px height=28></a>
<a role=checkbox class=navbar-burger aria-label=menu aria-expanded=false data-target=navigation><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=navigation class=navbar-menu><div class=navbar-end><div class=navbar-item><a href=/en/ class="nav link icon-text"><span class=icon><i class='fa fa-home'></i></span><span>Home</span></a></div><div class=navbar-item><a href=/en/contact/ class="nav link icon-text"><span class=icon><i class='fa fa-mail-bulk'></i></span><span>Contact</span></a></div><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link href=#>English (en)</a><div class="navbar-dropdown is-right"><a href=https://www.somethinglikegames.de/de/blog/2023/network-tutorial-5-login-3/ lang=de class=navbar-item>Deutsch (de)</a></div></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-one-fifth"><section id=site-sidebar class=is-hidden-mobile><section id=site-intro class="block has-text-centered"><a href=/en/><img src=/images/logo.webp class=circle width=128px height=128px alt=somethinglikegames.de></a><header></header><main><p>My personal Blog about Game Development as a single person in part time</p></main><footer class="footer has-no-background"><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-d5f4529aa1></span>
<script id=cloaked-script-d5f4529aa1>var cloakElement=document.getElementById("cloaked-d5f4529aa1"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></footer></section><div class=block><hr></div><section id=categories class="block categories"><header><h1><a href=/en/categories><span class=icon-text><span class=icon><i class="fa fa-folders"></i></span><span>Categories</span></span></a></h1></header><ul><li><a href=/en/categories/tutorial/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>tutorial</span></span><span class=count>6</span></a><li><a href=/en/categories/misc/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>misc</span></span><span class=count>3</span></a><li><a href=/en/categories/news/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>news</span></span><span class=count>1</span></a></li></ul></section></section></div><div class=column><article class=card><div class=card-image><a href=/en/blog/2023/network-tutorial-5-login-3/ class=cover-image style="--bg-image:url('https://www.somethinglikegames.de/images/blog/2023/network-tutorial-5-login-3/communicating_servers.webp')"><img class=cover src=https://www.somethinglikegames.de/images/blog/2023/network-tutorial-5-login-3/communicating_servers.webp alt="Godot Engine 'Server', die miteinander kommunizieren"></a><div class=copyright><a href=https://docs.midjourney.com/docs/terms-of-service class=has-text-grey target=_blank rel="noopener nofollow noreferrer"><img src=/images/cc-by-nc.webp alt=cc-by-nc> Midjourney</a></div></div><header class=card-header><div class=card-header-title><h2 class=title><a href=/en/blog/2023/network-tutorial-5-login-3/>Networking tutorial 5: Login 3 - world server</a></h2></div></header><div class="card-content is-size-5 content"><div class=columns><div class=column><time datetime="2023-03-26 12:00:00 +0100 +0100">March 26, 2023</time></div></div><div class=columns><div class=column><div class=tags><span class="tag is-info is-light"><a href=/en/categories/tutorial/ class=has-text-info><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span>
<span>Tutorial</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/networking-tutorial/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking-Tutorial</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/godot-engine/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Godot Engine</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/networking/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking</span></span></a></span></div></div></div><p>The source code to the articles can be found in this <a href=https://github.com/somethinglikegames/godot4-network-tutorial target=_blank rel="noopener nofollow noreferrer">GitHub repository</a>. The following list shows all articles of this series published so far:</p><ol><li><a href=/en/blog/2023/network-tutorial-1-overview/>Networking tutorial 1: General information and overview</a></li><li><a href=/en/blog/2023/network-tutorial-2-walking-skeleton/>Networking tutorial 2: The "walking skeleton"</a></li><li><a href=/en/blog/2023/network-tutorial-3-login-1/>Networking tutorial 3: Login 1 - The game client</a></li><li><a href=/en/blog/2023/network-tutorial-4-login-2/>Networking tutorial 4: Login 2 - gateway and authentication server</a></li><li>Networking tutorial 5: Login 3 - world server</li><li><a href=/en/blog/2023/network-tutorial-6-dtls/>Networking tutorial 6: Encrypted connections using DTLS</a></li></ol><p>In the <a href=/en/blog/2023/network-tutorial-4-login-2/>last article</a> we finished implementing the gateway and authentication server, so that the game client is issued a token for valid credentials. This token should now be used to log in to the world server. Therefore, in this article, we will extend the game client so that it forwards the token to the world server, and then enable the world server to verify the token.</p><h3 class="title is-4" id=extension-of-the-game-client>Extension of the game client</h3><p>So far the login process in the game client ends in the following function of <code>main.gd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#66d9ef>func</span> _login_callback(return_code: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>		print(<span style=color:#e6db74>&#34;Login was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		print(<span style=color:#e6db74>&#34;Current Token is: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>		<span style=color:#75715e># Connect to World Server</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	<span style=color:#66d9ef>else</span> :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>		print(<span style=color:#e6db74>&#34;Something went wrong…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>We already have minimal error handling so that the interface resets if something fails on login (line 41). But in case of success we currently end up with the once well-intentioned comment in line 38, so we will now make all preparations to replace the comment with real functionality. First we create a new script called <code>world_server.gd</code> below <code>scenes/network</code>.</p><h4 class="title is-5" id=world-server-network-client-scenesnetworkworld_servergd>World server network client (./scenes/network/world_server.gd)</h4><p>The basic framework that follows should be mostly known from the client for the gateway server. Probably one should extract the similarities once into a superclass, but that would make it more unclear at this point. The function <code>connect_to_server()</code> (line 9-25) tries to establish a connection to the world server. Server address and port are taken from a <code>NetworkConnectionData</code> object, which we must set beforehand. The considered error cases (lines 18 and 20) are handled as usual using <code>_on_connection_failed()</code>. To continue in our login process in case of success, we connect the <code>connected_to_server</code> signal from our <code>MultiplayerAPI</code> object to the <code>_on_connection_succeeded()</code> function (line 17).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>var</span> network :<span style=color:#f92672>=</span> ENetMultiplayerPeer<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>var</span> world_server : NetworkConnectionData
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>var</span> token : <span style=color:#a6e22e>String</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>var</span> callback : Callable
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>func</span> connect_to_server(_token: <span style=color:#a6e22e>String</span>, _callback: Callable) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	token <span style=color:#f92672>=</span> _token
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	callback <span style=color:#f92672>=</span> _callback
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	print(<span style=color:#e6db74>&#34;Connecting to </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> world_server<span style=color:#f92672>.</span>to_string())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>var</span> ret <span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>create_client(world_server<span style=color:#f92672>.</span>address, world_server<span style=color:#f92672>.</span>port)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>if</span> ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		get_multiplayer()<span style=color:#f92672>.</span>multiplayer_peer <span style=color:#f92672>=</span> network
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>connect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		get_multiplayer()<span style=color:#f92672>.</span>connection_failed<span style=color:#f92672>.</span>connect(_on_connection_failed<span style=color:#f92672>.</span>bind(FAILED))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		_on_connection_failed(ret)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#66d9ef>func</span> _on_connection_failed(ret: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	print(<span style=color:#e6db74>&#34;Failed to connect to world server on </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, errorcode was </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>			<span style=color:#f92672>%</span> [world_server<span style=color:#f92672>.</span>to_string(), ret])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	callback<span style=color:#f92672>.</span>call(ret, <span style=color:#e6db74>&#34;&#34;</span>)</span></span></code></pre></div><p>Once the connection to the server is established, the function <code>_on_connection_succeeded()</code> is called. There we then pass the token to the world server (line 32). We get the result of the token-based login as a parameter of the function <code>c_login_response()</code>. There we remove the link to the signal <code>connected_to_server</code>, since we are now no longer in possession of a token. Afterwards the passed callback is called so that the actual program flow in the game client can continue.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#66d9ef>func</span> _on_connection_succeeded() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	print(<span style=color:#e6db74>&#34;Succesfully connected to world server </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [world_server<span style=color:#f92672>.</span>to_string()])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	print(<span style=color:#e6db74>&#34;send login request to world server&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	s_login_request<span style=color:#f92672>.</span>rpc_id(MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER, token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#66d9ef>func</span> s_login_request(_token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	<span style=color:#66d9ef>pass</span> <span style=color:#75715e># on game server</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#66d9ef>func</span> c_login_response(result: <span style=color:#a6e22e>bool</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	print(<span style=color:#e6db74>&#34;login request result is </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> str(result))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>disconnect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	callback<span style=color:#f92672>.</span>call(OK <span style=color:#66d9ef>if</span> result <span style=color:#66d9ef>else</span> ERR_INVALID_DATA)</span></span></code></pre></div><h4 class="title is-5" id=main-scene-scenesmaingd>Main scene (./scenes/main.gd)</h4><p>Now we have prepared our network client for the world server so far that we can integrate it now also into the actual program flow. Therefore the previous function <code>_login_callback()</code> is extended in such a way that it now uses the just created network client to transmit the token to the world server. To make the code fragment shown below work, I added a new script variable called <code>world_server</code> of type <code>node</code>, similar to the already existing variable <code>gateway_server</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#66d9ef>func</span> _login_callback(return_code: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>	gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>		print(<span style=color:#e6db74>&#34;Current Token is: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>		world_server <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>		world_server<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WorldServer&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		add_child(world_server)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>		world_server<span style=color:#f92672>.</span>set_script(load(<span style=color:#e6db74>&#34;res://scenes/network/world_server.gd&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>		get_tree()<span style=color:#f92672>.</span>set_multiplayer(SceneMultiplayer<span style=color:#f92672>.</span>new(), <span style=color:#f92672>^</span><span style=color:#e6db74>&#34;/root/Main/WorldServer&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>		world_server<span style=color:#f92672>.</span>world_server <span style=color:#f92672>=</span> world_server_data
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>		world_server<span style=color:#f92672>.</span>connect_to_server(token, _world_server_callback)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#66d9ef>else</span> :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>		print(<span style=color:#e6db74>&#34;Something went wrong…&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>The newly added source code (lines 39-45) binds the network client of the world server into the <code>SceneTree</code> to subsequently call the function <code>login_to_server()</code> with the token there. For this I copied the code already existing from <a href=/en/blog/2023/network-tutorial-3-login-1/#scenehandler>Tutorial 3</a> for the gateway server client and adapted it to the world server. A new function <code>_world_server_callback</code> was passed as callback, which looks like this for now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#66d9ef>func</span> _world_server_callback(return_code: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		print(<span style=color:#e6db74>&#34;Login to world server was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>		<span style=color:#75715e># Add further game logic</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>		gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>		gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>		print(<span style=color:#e6db74>&#34;Login to world server failed&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()</span></span></code></pre></div><p>The error case leads, as before, to the reset of the interface, so that a new login attempt can be made, and in case of success we end now for the time being with a new comment 😉 in line 55.</p><h3 class="title is-4" id=extension-of-the-world-server>Extension of the world server</h3><p>Even if the game client is now prepared to log in to the world server, the world server is far from it. It only consists of the <a href=/en/blog/2023/network-tutorial-2-walking-skeleton/#the-server-base>server-base</a> and does not know anything about a login, let alone token validation. Therefore, the first step is to install the <a href=https://github.com/fenix-hub/godot-engine.jwt/releases target=_blank rel="noopener nofollow noreferrer">GDScript JWT</a> add-on, similar to the <a href=/en/blog/2023/network-tutorial-4-login-2/#authentication-server>last tutorial</a> on the authentication server. To do this, we first download the <a href=https://github.com/fenix-hub/godot-engine.jwt/releases target=_blank rel="noopener nofollow noreferrer">latest release</a> for Godot 4 and unzip the addons folder into our Godot project on the World server. Afterwards we have to activate the addon in the <code>project settings -> plugins</code>. After that we copy the <strong>public</strong> key from the authentication server from the <a href=/en/blog/2023/network-tutorial-4-login-2/#authentication-server>last tutorial</a> into a new folder <code>crypto</code> below the world server project directory.</p><h4 class="title is-5" id=world-server-scenesnetworkworld_servergd>World server (./scenes/network/world_server.gd)</h4><p>The preparations for validating JWT tokens are similar to those for generating <a href=/en/blog/2023/network-tutorial-4-login-2/#authentication-server>such tokens</a>. First we create a script variable of type <code>JWTAlgorithm</code>, then initialize it inside <code>_ready()</code>. An essential difference is that we only need the public key for the validation and therefore have to specify this as second parameter when loading the key (line 10). We store this key in our <code>JWTAlgorithm</code> variable as <code>_public_crypto</code> and of course set <code>JWTAlgorithm.Type.RSA256</code> as algorithm identical to the authentication server.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#66d9ef>var</span> jwt_algorithm: JWTAlgorithm
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#66d9ef>var</span> public_key :<span style=color:#f92672>=</span> CryptoKey<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#66d9ef>var</span> load_ret :<span style=color:#f92672>=</span> public_key<span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;res://crypto/jwt_rsa.pem&#34;</span>, true)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#66d9ef>if</span> load_ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>		jwt_algorithm <span style=color:#f92672>=</span> JWTAlgorithm<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		jwt_algorithm<span style=color:#f92672>.</span>_public_crypto <span style=color:#f92672>=</span> public_key
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		jwt_algorithm<span style=color:#f92672>.</span>_alg <span style=color:#f92672>=</span> JWTAlgorithm<span style=color:#f92672>.</span>Type<span style=color:#f92672>.</span>RSA256
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		print(<span style=color:#e6db74>&#34;Error while reading RSA public key: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> load_ret)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		get_tree()<span style=color:#f92672>.</span>quit(load_ret)</span></span></code></pre></div><p>The verification of the token takes place within <code>s_login_request</code>. For this we create a <code>JWTDecoder</code> with the help of the token (line 45) and then verify the signature with the help of the <code>JWTAlgorithm</code> initialized in <code>_ready()</code> (line 46). After that we make sure that the token is still valid (line 47). If the token both has a valid signature and is still valid, we send a positive result back to the client. If one of the tests is negative, we first send a negative response to the client and then disconnect.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#66d9ef>func</span> s_login_request(token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#66d9ef>var</span> now :<span style=color:#f92672>=</span> <span style=color:#a6e22e>int</span>(Time<span style=color:#f92672>.</span>get_unix_time_from_system())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#66d9ef>var</span> user_id :<span style=color:#f92672>=</span> get_multiplayer()<span style=color:#f92672>.</span>get_remote_sender_id()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#66d9ef>var</span> jwt :<span style=color:#f92672>=</span> JWTDecoder<span style=color:#f92672>.</span>new(token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>	<span style=color:#66d9ef>var</span> is_signature_valid :<span style=color:#f92672>=</span> jwt_algorithm<span style=color:#f92672>.</span>verify(jwt)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	<span style=color:#66d9ef>var</span> is_unexpired <span style=color:#f92672>=</span> now <span style=color:#f92672>&lt;=</span> jwt<span style=color:#f92672>.</span>get_expires_at()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>	<span style=color:#66d9ef>if</span> is_signature_valid <span style=color:#f92672>and</span> is_unexpired:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>		c_login_response<span style=color:#f92672>.</span>rpc_id(user_id, true)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>		c_login_response<span style=color:#f92672>.</span>rpc_id(user_id, false)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>		disconnect_player(user_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#66d9ef>func</span> c_login_response(_result: <span style=color:#a6e22e>bool</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>	<span style=color:#66d9ef>pass</span> <span style=color:#75715e># on game client</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#66d9ef>func</span> disconnect_player(user_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>	get_multiplayer()<span style=color:#f92672>.</span>disconnect_peer(user_id)</span></span></code></pre></div><p>Now (finally) our login process is complete and our game client has established an authenticated connection to the world server without the need for the world server to have passwords.</p><h3 class="title is-4" id=obtaining-connection-information>Obtaining connection information</h3><p>To conclude this tutorial I would like to talk about another new feature of Godot 4: &ldquo;Lower-level ENet&rdquo;. <a href=http://enet.bespin.org/ target=_blank rel="noopener nofollow noreferrer">ENet</a> also has some interesting features besides just network communication that can be very useful. For example, ENet actually has a direct way to query the &ldquo;round-trip time&rdquo; (RTT) of a connection. Only until Godot 4, ENet was encapsulated in such a way that you couldn&rsquo;t access this information within GDScript. So I&rsquo;m pleased to report that, among the incredible number of other changes in Godot 4, this has also been <a href=https://github.com/godotengine/godot/pull/50710 target=_blank rel="noopener nofollow noreferrer">changed</a>. Thus, wrappers now exist with <a href=https://docs.godotengine.org/en/stable/classes/class_enetconnection.html target=_blank rel="noopener nofollow noreferrer"><code>ENetConnection</code></a> and <a href=https://docs.godotengine.org/en/stable/classes/class_enetpacketpeer.html target=_blank rel="noopener nofollow noreferrer"><code>ENetPacketPeer</code></a> that provide access to the actual ENet functionality. <a href=https://github.com/Faless target=_blank rel="noopener nofollow noreferrer">Fabio Alessandrelli (Faless)</a> has also written a worth reading <a href=https://godotengine.org/article/multiplayer-changes-godot-4-0-report-3/ target=_blank rel="noopener nofollow noreferrer">Blogpost as Progress Report</a> on the Godot site.</p><p>To test these new possibilities, it might be a good idea to extend the game client so that it regularly outputs the RTT towards the world server. For this we first extend <code>./scenes/network/world_server.gd</code> with a new script variable, where we store our <code>ENetPacketPeer</code> object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#66d9ef>var</span> peer : ENetPacketPeer <span style=color:#f92672>=</span> null</span></span></code></pre></div><p>Since the game client as a network client is only connected to the world server, it only knows one peer. Therefore, in my humble opinion, the easiest way to get the appropriate object is to get access to the associated <code>ENetConnection</code> via our <code>ENetMultiplayerPeer</code> object, where we then grab the first (and only) <code>ENetPacketPeer</code> (line 46).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#66d9ef>func</span> c_login_response(result: <span style=color:#a6e22e>bool</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	print(<span style=color:#e6db74>&#34;login request result is </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> str(result))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	get_multiplayer()<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>disconnect(_on_connection_succeeded)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>	<span style=color:#66d9ef>if</span> result:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>		peer <span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>get_host()<span style=color:#f92672>.</span>get_peers()[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	callback<span style=color:#f92672>.</span>call(OK <span style=color:#66d9ef>if</span> result <span style=color:#66d9ef>else</span> ERR_INVALID_DATA)</span></span></code></pre></div><p>Thus, we can subsequently call <a href=https://docs.godotengine.org/en/stable/classes/class_enetpacketpeer.html#class-enetpacketpeer-method-get-statistic target=_blank rel="noopener nofollow noreferrer"><code>get_statistic()</code></a> at any time on our network connection and provide, for example, a function to query the average RTT:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#66d9ef>func</span> get_rtt() <span style=color:#f92672>-&gt;</span> <span style=color:#a6e22e>float</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	<span style=color:#66d9ef>if</span> peer:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>		<span style=color:#66d9ef>return</span> peer<span style=color:#f92672>.</span>get_statistic(ENetPacketPeer<span style=color:#f92672>.</span>PEER_ROUND_TRIP_TIME)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span></span></span></code></pre></div><p>Now we just have to extend our main scene script <code>./scenes/main.gd</code> a bit. First we add a variable for a timer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#66d9ef>var</span> rtt_timer : <span style=color:#a6e22e>Timer</span></span></span></code></pre></div><p>And then we extend <code>_world_server_callback()</code>. If we managed a successful connection to the world server, we create a new timer, add it to the <code>SceneTree</code>, link the <code>timeout</code> signal of the timer and start it with an interval of 5 seconds. In the function that is now called by the <code>timeout</code> signal of the timer, we query our RTT.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#66d9ef>func</span> _world_server_callback(return_code: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>	<span style=color:#66d9ef>if</span> return_code <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>		print(<span style=color:#e6db74>&#34;Login to world server was successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>		rtt_timer <span style=color:#f92672>=</span> <span style=color:#a6e22e>Timer</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>		add_child(rtt_timer)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>		rtt_timer<span style=color:#f92672>.</span>timeout<span style=color:#f92672>.</span>connect(_on_rtt_timer_timeout)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>		rtt_timer<span style=color:#f92672>.</span>start(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>		<span style=color:#75715e># Add further game logic</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>		gateway_server<span style=color:#f92672>.</span>queue_free()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>		gateway_server <span style=color:#f92672>=</span> null
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>		print(<span style=color:#e6db74>&#34;Login to world server failed&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>		get_node(<span style=color:#e6db74>&#34;LoginScreen&#34;</span>)<span style=color:#f92672>.</span>reset()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#66d9ef>func</span> _on_rtt_timer_timeout() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>	<span style=color:#66d9ef>if</span> world_server:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>		print(<span style=color:#e6db74>&#34;RTT: </span><span style=color:#e6db74>%f</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> world_server<span style=color:#f92672>.</span>get_rtt())</span></span></code></pre></div><div class="message is-info"><div class=message-body>One should not be surprised about the relatively high values ~15-20ms for the RTT in local tests. This may sound high at first, since the connection is local, but you have to consider that the RTT not only includes the way there and back, which is omitted locally, but also the processing time on the server.</div></div><h3 class="title is-4" id=the-next-step>The next step</h3><p>Before we start spawning player characters or actively exchanging messages between the game client and the world server, which are all scheduled topics for this tutorial series, we will deal with <a href=https://de.wikipedia.org/wiki/Datagram_Transport_Layer_Security target=_blank rel="noopener nofollow noreferrer">DTLS</a> in the next tutorial. So we will take care of encrypting the network connections between all communication partners in order to protect passwords sent by the game client on the one hand and to make &ldquo;hacking&rdquo; by e.g. cheat software more difficult on the other hand.</p></div></article><footer class=columns><div class="column has-text-left"><a href=/en/blog/2023/network-tutorial-4-login-2/ class="button right"><span class=icon-text><span class=icon><i class="fa fa-angle-left"></i></span><span>Networking tutorial 4: Login 2 - gateway and authentication server</span></span></a></div><div class="column has-text-right"><a href=/en/blog/2023/network-tutorial-6-dtls/ class="button left"><span class=icon-text><span>Networking tutorial 6: Encrypted connections using DTLS</span><span class=icon><i class="fa fa-angle-right"></i></span></span></a></div></footer></div></div></div></section><footer class=footer><div class="container is-fluid has-text-centered"><ul class=socnet-icons><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-176a90dcb9></span>
<script id=cloaked-script-176a90dcb9>var cloakElement=document.getElementById("cloaked-176a90dcb9"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></ul><p class=copyright><a href=https://www.somethinglikegames.de/en/legal_notice/>Legal Notice</a> &mdash;
<a href=https://www.somethinglikegames.de/en/privacy_policy/>Privacy Policy</a> &mdash;
©2023 Tobias Wink<br>Powered by <a href=https://gohugo.io/ title=0.109.0 target=_blank rel=noopener>Hugo</a></p></div></footer><script src=/js/navbar.min.js defer></script>
<script src=/js/copy-code-button.min.js defer></script></body></html>