<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/sass/main.min.143551db89e311bf410f22e9ac4f1dd2496146fdc9f5bf27ac1a1839c6ce424fc8526487f0733de4c3e7617b55e897f6b91b57dd3abbf3e9ab4e1a59c1448e44.css integrity="sha512-FDVR24njEb9BDyLprE8d0klhRv3J9b8nrBoYOcbOQk/IUmSH8HM95MPnYXtV6Jf2uRtX3Tq78+mrThpZwUSORA=="><link rel=stylesheet href=/css/all.min.a0921f068fa9017ba1288b77420fbde17d89619431fab12b4d996e3e124af17337ac1b80bc2bb62458509e6033ace757405b5881b0c1d0db837dd64c8783b607.css integrity="sha512-oJIfBo+pAXuhKIt3Qg+94X2JYZQx+rErTZluPhJK8XM3rBuAvCu2JFhQnmAzrOdXQFtYgbDB0NuDfdZMh4O2Bw=="><title>Something Like Games | Networking tutorial 4: Login 2 - gateway and authentication server</title><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><meta name=description content="This part of the tutorial series is about the second part of the login process. The login call is forwarded from the gateway server to the authentication server."><meta itemprop=description content="This part of the tutorial series is about the second part of the login process. The login call is forwarded from the gateway server to the authentication server."><meta name=twitter:description content="This part of the tutorial series is about the second part of the login process. The login call is forwarded from the gateway server to the authentication server."><meta property="og:description" content="This part of the tutorial series is about the second part of the login process. The login call is forwarded from the gateway server to the authentication server."></head><body><nav class="navbar is-light" role=navigation aria-label="main navigation"><div class=navbar-brand><a href=/en/ class=navbar-item><img src=/images/brand.webp alt="Something Like Games" width=128px height=28></a>
<a role=checkbox class=navbar-burger aria-label=menu aria-expanded=false data-target=navigation><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a></div><div id=navigation class=navbar-menu><div class=navbar-end><div class=navbar-item><a href=/en/ class="nav link icon-text"><span class=icon><i class='fa fa-home'></i></span><span>Home</span></a></div><div class=navbar-item><a href=/en/contact/ class="nav link icon-text"><span class=icon><i class='fa fa-mail-bulk'></i></span><span>Contact</span></a></div><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link href=#>English (en)</a><div class="navbar-dropdown is-right"><a href=https://www.somethinglikegames.de/de/blog/2023/network-tutorial-4-login-2/ lang=de class=navbar-item>Deutsch (de)</a></div></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-one-fifth"><section id=site-sidebar class=is-hidden-mobile><section id=site-intro class="block has-text-centered"><a href=/en/><img src=/images/logo.webp class=circle width=128px height=128px alt=somethinglikegames.de></a><header></header><main><p>My personal Blog about Game Development as a single person in part time</p></main><footer class="footer has-no-background"><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-c05831ad35></span>
<script id=cloaked-script-c05831ad35>var cloakElement=document.getElementById("cloaked-c05831ad35"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></footer></section><div class=block><hr></div><section id=categories class="block categories"><header><h1><a href=/en/categories><span class=icon-text><span class=icon><i class="fa fa-folders"></i></span><span>Categories</span></span></a></h1></header><ul><li><a href=/en/categories/tutorial/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>tutorial</span></span><span class=count>6</span></a><li><a href=/en/categories/misc/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>misc</span></span><span class=count>3</span></a><li><a href=/en/categories/news/><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span><span>news</span></span><span class=count>1</span></a></li></ul></section></section></div><div class=column><article class=card><div class=card-image><a href=/en/blog/2023/network-tutorial-4-login-2/ class=cover-image style="--bg-image:url('https://www.somethinglikegames.de/images/blog/2023/network-tutorial-4-login-2/communicating_servers.webp')"><img class=cover src=https://www.somethinglikegames.de/images/blog/2023/network-tutorial-4-login-2/communicating_servers.webp alt="Godot Engine Logos, die miteinander 'kommunizieren'"></a><div class=copyright><a href=https://github.com/YuriSizov/godot-emotes/blob/master/LICENSE class=has-text-grey target=_blank rel="noopener nofollow noreferrer">Godot emotes are licensed under CC-BY-4.0 by Yuri Sizov</a></div></div><header class=card-header><div class=card-header-title><h2 class=title><a href=/en/blog/2023/network-tutorial-4-login-2/>Networking tutorial 4: Login 2 - gateway and authentication server</a></h2></div></header><div class="card-content is-size-5 content"><div class=columns><div class=column><time datetime="2023-03-12 11:30:00 +0100 +0100">March 12, 2023</time></div></div><div class=columns><div class=column><div class=tags><span class="tag is-info is-light"><a href=/en/categories/tutorial/ class=has-text-info><span class=icon-text><span class=icon><i class="fa fa-folder"></i></span>
<span>Tutorial</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/networking-tutorial/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking-Tutorial</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/godot-engine/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Godot Engine</span></span></a></span>
<span class="tag is-link is-light"><a href=/en/tags/networking/ class=has-text-link><span class=icon-text><span class=icon><i class="fa fa-tag"></i></span>
<span>Networking</span></span></a></span></div></div></div><p>The source code for this tutorial series can be found in this <a href=https://github.com/somethinglikegames/godot4-network-tutorial target=_blank rel="noopener nofollow noreferrer">GitHub repository</a>. The following list shows all articles of this series published so far:</p><ol><li><a href=/en/blog/2023/network-tutorial-1-overview/>Networking tutorial 1: General information and overview</a></li><li><a href=/en/blog/2023/network-tutorial-2-walking-skeleton/>Networking tutorial 2: The "walking skeleton"</a></li><li><a href=/en/blog/2023/network-tutorial-3-login-1/>Networking tutorial 3: Login 1 - The game client</a></li><li>Networking tutorial 4: Login 2 - gateway and authentication server</li><li><a href=/en/blog/2023/network-tutorial-5-login-3/>Networking tutorial 5: Login 3 - world server</a></li><li><a href=/en/blog/2023/network-tutorial-6-dtls/>Networking tutorial 6: Encrypted connections using DTLS</a></li></ol><p>In the <a href=/en/blog/2023/network-tutorial-3-login-1/>last article</a> we created the game client to the point where it wants to contact the gateway server with login data. In this article, we will continue at this exact point and take care of the gateway server and authentication server. However, before we can take care of the actual login process, we first have to make the gateway and authentication servers familiar with each other and make sure that they trust each other. We use a mechanism that allows mutual authentication already during the connection setup and that was only introduced in Godot 4 in November 2022.</p><h3 class="title is-4" id=pre-authentication>Pre-Authentication</h3><p>The author of the <a href=https://github.com/godotengine/godot/pull/67917 target=_blank rel="noopener nofollow noreferrer">pull request</a> talks about pre-authentication, because the authentication already happens during the connection setup, while in the <a href=/en/blog/2023/network-tutorial-3-login-1/>game client</a> we sent the login data only after we are already connected to the gateway server, i.e. we got the signal <code>connected_to_server</code>. Despite a short description in the <a href=https://github.com/godotengine/godot/pull/67917 target=_blank rel="noopener nofollow noreferrer">pull request</a>, I had to experiment a bit to get the desired behavior working. I first thought that only the client authenticates itself to the server, but it is a mutual authentication, and only when both parties have agreed to the connection, it is actually established.</p><p>To enable pre-authentication, we have to set the <code>auth_callback</code> in the <code>SceneMultiplayer</code> object on both sides with a <code>callable</code>, which contains the authentication logic. In addition, during connection establishment we have so far only been interested in the <code>connected_to_server</code> and <code>connection_failed</code> signals as client and <code>peer_connected</code> and <code>peer_disconnected</code> as server, respectively. In the context of pre-authentication, we now additionally consider the two further signals <code>peer_authenticating</code> and <code>peer_authentication_failed</code> on both sides.</p><p>The <code>peer_authenticating</code> signal is emitted when a new connection is established and should be used to send the authentication-relevant data to the remote peer using <code>send_auth(id: int, data: PackedByteArray)</code>. <code>send_auth()</code> then triggers the stored <code>auth_callback</code> at the remote peer to validate the sent data. The success case is then signaled <code>complete_auth(id: int)</code>. If both parties have done this within 30 seconds, the network connection is finally established and communicated to the client using <code>connected_to_server</code> or to the server using <code>peer_connected</code>.</p><p>So, enough of the theory, here now the example code of the gateway server (client):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>var</span> authentication_server :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#960050;background-color:#1e0010>@</span>export_range(<span style=color:#ae81ff>1025</span>, <span style=color:#ae81ff>65536</span>) <span style=color:#66d9ef>var</span> authentication_server_port :<span style=color:#f92672>=</span> <span style=color:#ae81ff>1911</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>var</span> shared_secret :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;JustARandomValueYouCantGuess&#34;</span><span style=color:#f92672>.</span>to_utf8_buffer()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>var</span> _crypto :<span style=color:#f92672>=</span> Crypto<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>var</span> network :<span style=color:#f92672>=</span> ENetMultiplayerPeer<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>var</span> shutdown_hook : Callable
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#66d9ef>var</span> gateway_server : <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#66d9ef>func</span> startup() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	print(<span style=color:#e6db74>&#34;Connecting to </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>:</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [authentication_server, authentication_server_port])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>var</span> ret <span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>create_client(authentication_server, authentication_server_port)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#66d9ef>var</span> _hash :<span style=color:#f92672>=</span> _crypto<span style=color:#f92672>.</span>hmac_digest(HashingContext<span style=color:#f92672>.</span>HASH_SHA256, shared_secret,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>			Time<span style=color:#f92672>.</span>get_date_string_from_system(true)<span style=color:#f92672>.</span>to_utf8_buffer())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	<span style=color:#66d9ef>if</span> ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		multiplayer<span style=color:#f92672>.</span>multiplayer_peer <span style=color:#f92672>=</span> network
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		multiplayer<span style=color:#f92672>.</span>connection_failed<span style=color:#f92672>.</span>connect(_on_connection_failed<span style=color:#f92672>.</span>bind(FAILED))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		multiplayer<span style=color:#f92672>.</span>connected_to_server<span style=color:#f92672>.</span>connect(<span style=color:#66d9ef>func</span>() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>				print(<span style=color:#e6db74>&#34;Succesfully connected to authentication server </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>:</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>						<span style=color:#f92672>%</span> [authentication_server, authentication_server_port]))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        multiplayer<span style=color:#f92672>.</span>peer_authenticating<span style=color:#f92672>.</span>connect(<span style=color:#66d9ef>func</span>(server_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>				print(<span style=color:#e6db74>&#34;server_id </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> peer_authenticating&#34;</span> <span style=color:#f92672>%</span> server_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>				<span style=color:#66d9ef>if</span> server_id <span style=color:#f92672>==</span> MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>					multiplayer<span style=color:#f92672>.</span>send_auth(server_id, _hash))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>		multiplayer<span style=color:#f92672>.</span>peer_authentication_failed<span style=color:#f92672>.</span>connect(<span style=color:#66d9ef>func</span>(server_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>				print(<span style=color:#e6db74>&#34;server_id </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> peer_authentication_failed&#34;</span> <span style=color:#f92672>%</span> server_id))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>		multiplayer<span style=color:#f92672>.</span>auth_callback <span style=color:#f92672>=</span> \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>				<span style=color:#66d9ef>func</span>(server_id: <span style=color:#a6e22e>int</span>, data: PackedByteArray) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>					print(<span style=color:#e6db74>&#34;server </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> sent </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [server_id, data<span style=color:#f92672>.</span>hex_encode()])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>					<span style=color:#66d9ef>if</span> _crypto<span style=color:#f92672>.</span>constant_time_compare(_hash, data):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>						multiplayer<span style=color:#f92672>.</span>complete_auth(server_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>					<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>						print(<span style=color:#e6db74>&#34;Validation was not successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>		_on_connection_failed(ret)</span></span></code></pre></div><div class="message is-warning"><div class=message-body>For security reasons, in a production scenario, of course, no password/shared secret or similar should be stored directly in the source code, but loaded as a resource or via configuration file. But for the tutorial it was more convenient to store it directly in the source code.</div></div><p>In the source code all previously mentioned places should be found. Authentication validation takes place using the current system date (UTC). With this (line 17) the gateway server creates a <a href=https://en.wikipedia.org/wiki/HMAC target=_blank rel="noopener nofollow noreferrer">HMAC</a> (line 16). The key must be identical on both servers for this. I used the current system date (UTC) because both servers only need approximately the same system time and it could only cause problems during the minutes around midnight. In practice, of course, it should be ensured that all servers have as accurate a system time as possible, so that you don&rsquo;t do the check there on a daily basis, but on a minute basis. This makes replay attacks much more difficult to perform, since the generated HMAC changes every minute, and not just every day, as shown in the example.</p><p>The corresponding source code in the authentication server looks similar. The biggest difference is that new HMACs are generated for each request or validation, since it is unknown whether an older HMAC can still be valid:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#960050;background-color:#1e0010>@</span>export_range(<span style=color:#ae81ff>1025</span>, <span style=color:#ae81ff>65536</span>) <span style=color:#66d9ef>var</span> network_port :<span style=color:#f92672>=</span> <span style=color:#ae81ff>1911</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#960050;background-color:#1e0010>@</span>export_range(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4095</span>) <span style=color:#66d9ef>var</span> max_clients :<span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>var</span> shared_secret :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;JustARandomValueYouCantGuess&#34;</span><span style=color:#f92672>.</span>to_utf8_buffer()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>var</span> _crypto <span style=color:#f92672>=</span> Crypto<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>var</span> peers <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#66d9ef>func</span> startup() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	<span style=color:#66d9ef>var</span> network :<span style=color:#f92672>=</span> ENetMultiplayerPeer<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	<span style=color:#66d9ef>var</span> ret :<span style=color:#f92672>=</span> network<span style=color:#f92672>.</span>create_server(network_port, max_clients)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>if</span> ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>		multiplayer<span style=color:#f92672>.</span>server_relay <span style=color:#f92672>=</span> false
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		multiplayer<span style=color:#f92672>.</span>set_multiplayer_peer(network)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		print(<span style=color:#e6db74>&#34;Server started on port </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>, allowing max </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> connections&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>				<span style=color:#f92672>%</span> [network_port, max_clients])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>		multiplayer<span style=color:#f92672>.</span>peer_connected<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>				<span style=color:#66d9ef>func</span>(client_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>						print(<span style=color:#e6db74>&#34;Client </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> connected&#34;</span> <span style=color:#f92672>%</span> client_id))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		multiplayer<span style=color:#f92672>.</span>peer_disconnected<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>				<span style=color:#66d9ef>func</span>(client_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>						print(<span style=color:#e6db74>&#34;Client </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> disconnected&#34;</span> <span style=color:#f92672>%</span> client_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>						peers<span style=color:#f92672>.</span>erase(client_id))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>		multiplayer<span style=color:#f92672>.</span>peer_authenticating<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>				<span style=color:#66d9ef>func</span>(client_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>						print(<span style=color:#e6db74>&#34;Client </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> peer_authenticating&#34;</span> <span style=color:#f92672>%</span> client_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>						<span style=color:#66d9ef>var</span> _hash :<span style=color:#f92672>=</span> _crypto<span style=color:#f92672>.</span>hmac_digest(HashingContext<span style=color:#f92672>.</span>HASH_SHA256,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                        		shared_secret,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                                Time<span style=color:#f92672>.</span>get_date_string_from_system(true)<span style=color:#f92672>.</span>to_utf8_buffer())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>						multiplayer<span style=color:#f92672>.</span>send_auth(client_id, _hash))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		multiplayer<span style=color:#f92672>.</span>peer_authentication_failed<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>				<span style=color:#66d9ef>func</span>(client_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>						print(<span style=color:#e6db74>&#34;Client </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> peer_authentication_failed&#34;</span> <span style=color:#f92672>%</span> client_id))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>		multiplayer<span style=color:#f92672>.</span>auth_callback <span style=color:#f92672>=</span> \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>				<span style=color:#66d9ef>func</span>(client_id: <span style=color:#a6e22e>int</span>, data: PackedByteArray) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>						print(<span style=color:#e6db74>&#34;Client </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> sent: </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [client_id, data<span style=color:#f92672>.</span>hex_encode()])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>						<span style=color:#66d9ef>var</span> _hash :<span style=color:#f92672>=</span> _crypto<span style=color:#f92672>.</span>hmac_digest(HashingContext<span style=color:#f92672>.</span>HASH_SHA256,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>								shared_secret,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>								Time<span style=color:#f92672>.</span>get_date_string_from_system(true)<span style=color:#f92672>.</span>to_utf8_buffer())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>						<span style=color:#66d9ef>if</span> _crypto<span style=color:#f92672>.</span>constant_time_compare(_hash, data):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>							multiplayer<span style=color:#f92672>.</span>complete_auth(client_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>							peers<span style=color:#f92672>.</span>append(client_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>						<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>							print(<span style=color:#e6db74>&#34;Validation was not successful&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>		print(<span style=color:#e6db74>&#34;Error while starting server: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> ret)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>		get_tree()<span style=color:#f92672>.</span>quit(ret)</span></span></code></pre></div><h3 class="title is-4" id=gateway-server>Gateway-Server</h3><p>Now that the gateway server and the authentication server can communicate with each other in a basic way and, more importantly, can trust each other, we start in this section to implement the actual task of the gateway server, which is to be machine-in-the-middle ðŸ˜‰ between the client and the authentication server.</p><figure class="title is-6 center"><img src=/images/blog/2023/network-tutorial-3-login-1/login_sequence_synchrone.webp alt="Synchrone Loginsequenz"><figcaption><h4>Synchrone Loginsequenz</h4></figcaption></figure><p>In the <a href=/en/blog/2023/network-tutorial-3-login-1/>last article</a>, we called the <code>s_login_request()</code> function on the gateway server as a game client with the entered login data. Thus, this is now our entry point. The sequence diagram for the synchronous login sequence is once again our model and we can see from the diagram that the next step is to forward the game client&rsquo;s login request to the authentication server. To do this, we first implement the called function within <code>gateway_server.gd</code> of the gateway server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#66d9ef>func</span> s_login_request(username: <span style=color:#a6e22e>String</span>, password: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>	<span style=color:#66d9ef>var</span> player_id :<span style=color:#f92672>=</span> multiplayer<span style=color:#f92672>.</span>get_remote_sender_id()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>	print(<span style=color:#e6db74>&#34;login request received by </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> player_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>	authentication_server<span style=color:#f92672>.</span>authenticate_player(username, password, player_id)</span></span></code></pre></div><p>As we can see, besides a debug console output, the function <code>authenticate_player()</code> is called there within <code>authentication_server.gd</code>. The transmitted login data and the network ID of the game client are passed as parameters. This network ID is previously determined in line 50 by calling <code>multiplayer.get_remote_sender_id()</code>. As you can see in the code below, the call to <code>authenticate_player()</code> in <code>authentication_server.gd</code> actually only passes the passed parameters to the authentication server. The authentication server only needs the login data and not the network ID of the game client, but we still pass it through the authentication server so that we still know how to reach the game client when we later forward the response to it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#66d9ef>func</span> authenticate_player(username: <span style=color:#a6e22e>String</span>, password: <span style=color:#a6e22e>String</span>, player_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>	print(<span style=color:#e6db74>&#34;sending authentication request for player_id: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> player_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>	s_authenticate_player<span style=color:#f92672>.</span>rpc_id(MultiplayerPeer<span style=color:#f92672>.</span>TARGET_PEER_SERVER,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>			username, password, player_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#66d9ef>func</span> s_authenticate_player(_username: <span style=color:#a6e22e>String</span>, _password: <span style=color:#a6e22e>String</span>, _player_id: <span style=color:#a6e22e>int</span>) \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span> <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>	<span style=color:#66d9ef>pass</span> <span style=color:#75715e># on authentication server</span></span></span></code></pre></div><p>As shown in the sequence diagram and addressed in the previous paragraph, the gateway server also has the task of forwarding the authentication server&rsquo;s response to the game client. For this purpose, the gateway server provides the <code>c_authentication_result()</code> function in <code>authentication_server.gd</code>. This function is then called by the authentication server via RPC. The result, the network ID of the game client and, if successful, a token are transmitted as parameters. As before, the gateway server has no logic of its own, but only acts as an intermediary between the game client and the authentication server. Therefore, in addition to debug console messages, only the <code>return_login_request()</code> function of <code>gateway_server.gd</code> is called with the received parameters (line 68).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;authority&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span><span style=color:#66d9ef>func</span> c_authentication_result(result: <span style=color:#a6e22e>bool</span>, player_id: <span style=color:#a6e22e>int</span>, token: <span style=color:#a6e22e>String</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>	print(<span style=color:#e6db74>&#34;authentication result for player_id: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> is </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> [player_id, str(result)])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>	gateway_server<span style=color:#f92672>.</span>return_login_request(result, token, player_id)</span></span></code></pre></div><p>As expected, the <code>return_login_request()</code> function in <code>gateway_server.gd</code> forwards all parameters via RPC to the original game client (line 42). If there is still a connection to the game client after this RPC call, it will be disconnected as soon as all intended messages have actually been sent (lines 43-45). It may also happen in practice that the game client disconnects while the gateway server is in the process of executing line 199. In this case, line 200 results in an error message, which we can then ignore.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#66d9ef>func</span> return_login_request(result: <span style=color:#a6e22e>bool</span>, token: <span style=color:#a6e22e>String</span>, player_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>	c_login_response<span style=color:#f92672>.</span>rpc_id(player_id, result, token)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	<span style=color:#66d9ef>var</span> peer: ENetPacketPeer <span style=color:#f92672>=</span> multiplayer<span style=color:#f92672>.</span>multiplayer_peer<span style=color:#f92672>.</span>get_peer(player_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>	<span style=color:#66d9ef>if</span> peer <span style=color:#f92672>!=</span> null:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>		peer<span style=color:#f92672>.</span>peer_disconnect_later()</span></span></code></pre></div><p>With this, we have finished implementing the complete functionality of the gateway server.</p><h3 class="title is-4" id=authentication-server>Authentication-Server</h3><p>The central task of our authentication server is the verification of transmitted login data. If the login data is valid, a token is generated which is accepted by the world server. As you can see in the following code snippet, I make my life a bit easier again by currently accepting all login data whose username and password match (line 73).</p><div class="message is-warning"><div class=message-body><p>In reality, one would do this differently and instead read the password hash, which was generated with a <a href=https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html target=_blank rel="noopener nofollow noreferrer">secure method</a>, to the submitted username from the database and then check the submitted password with the password hash of the database query. I plan to go into more detail on this topic in a later article, but it&rsquo;s not the right time yet.</p><p>Especially since Godot 4 is not even 2 weeks old at the time of article publication and therefore there are currently no stable add-ons for database clients, even though <a href=https://github.com/2shady4u/godot-sqlite/tree/gd-extension target=_blank rel="noopener nofollow noreferrer">godot-sqlite</a> and <a href=https://github.com/Marzin-bot/PostgreSQLClient/tree/alpha target=_blank rel="noopener nofollow noreferrer">PostgreSQLClient</a> already provide first test versions for Godot 4.</p></div></div><p>As we can see in line 78, no token is generated here yet, we will deal with this specifically in the next section. In line 79, the result, <code>player_id</code> (network ID of the game client) and a token are sent via RPC to the gateway server from which the request came.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#960050;background-color:#1e0010>@</span>rpc(<span style=color:#e6db74>&#34;call_remote&#34;</span>, <span style=color:#e6db74>&#34;any_peer&#34;</span>, <span style=color:#e6db74>&#34;reliable&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span><span style=color:#66d9ef>func</span> s_authenticate_player(username: <span style=color:#a6e22e>String</span>, password: <span style=color:#a6e22e>String</span>, player_id: <span style=color:#a6e22e>int</span>) <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>	print(<span style=color:#e6db74>&#34;authentication requested for player_id: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> player_id)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>	<span style=color:#66d9ef>var</span> gateway_id :<span style=color:#f92672>=</span> multiplayer<span style=color:#f92672>.</span>get_remote_sender_id()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>	<span style=color:#66d9ef>var</span> result <span style=color:#f92672>=</span> username <span style=color:#f92672>==</span> password <span style=color:#75715e># add real user accounts and real check</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>	print(<span style=color:#e6db74>&#34;return authentication result (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>) for player_id: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74> to gateway_id: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>			<span style=color:#f92672>%</span> [str(result), player_id, gateway_id])
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>	<span style=color:#66d9ef>var</span> token :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>	<span style=color:#66d9ef>if</span> result:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>		<span style=color:#66d9ef>pass</span> <span style=color:#75715e># Create Token</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>	c_authentication_result<span style=color:#f92672>.</span>rpc_id(gateway_id, result, player_id, token)</span></span></code></pre></div><h4 class="title is-5" id=token-generation>Token generation</h4><p>I&rsquo;ve moved token generation to an extra section because I imagine not everyone is already familiar with <a href=https://jwt.io/ target=_blank rel="noopener nofollow noreferrer">JWTs</a>, so I&rsquo;d like to start a bit more general with the topic. <a href=https://jwt.io/ target=_blank rel="noopener nofollow noreferrer">JWT</a> (pronounced &ldquo;jot&rdquo;) is short for JSON Web Token and is defined/standardized in <a href=https://www.rfc-editor.org/rfc/rfc7519 target=_blank rel="noopener nofollow noreferrer">RFC 7519</a>. In <a href=https://www.rfc-editor.org/rfc/rfc7519 target=_blank rel="noopener nofollow noreferrer">RFC 7519</a> is the following short description for JWTs:</p><blockquote><p>JSON Web Token (JWT) is a compact, URL-safe means of representing claims to be transferred between two parties. The claims in a JWT are encoded as a JSON object that is used as the payload of a JSON Web Signature (JWS) structure or as the plaintext of a JSON Web Encryption (JWE) structure, enabling the claims to be digitally signed or integrity protected with a Message Authentication Code (MAC) and/or encrypted.</p></blockquote><p>We are thus dealing with a compact URL-secure way of transferring claims between two parties. The claims are encoded as JSON objects and can be used within JSON Web Signatures (JWS) or JSON Web Encryptions (JWE). We will use them as part of JSON Web Signatures and protect them from modification (more on that later). Claims are, quite abstractly, statements or assignments about a particular party or object and can be succinctly described as information. We thus have a standardized format for transferring information between two parties and can protect that information from change. This is exactly what we need to allow the game client to access the world server without the world server being able to verify the identity of the game client.</p><p>For protection against modification, we rely on the <code>RSA SHA256</code> algorithm, so we generate a hash value of our claims using <a href=https://en.wikipedia.org/wiki/SHA-2 target=_blank rel="noopener nofollow noreferrer"><code>SHA256</code></a> and sign it using <a href=https://en.wikipedia.org/wiki/RSA_%28cryptosystem%29 target=_blank rel="noopener nofollow noreferrer">RSA</a>. This has the advantage that we use two different keys for signing and signature verification by using the asymmetric RSA method. This means that even if the world server is compromised, i.e., stolen, hacked, etc., the authentication server remains the only party that can issue our tokens.</p><p>Basically, a JWT can be divided into three parts: Header, Payload and Signature, each separated by a <code>.</code>. The header and payload are encoded in Base64 URL so that there are no problems during transfer via HTTP. What information is contained in a JWT can be checked for example in the <a href=https://jwt.io/#debugger-io target=_blank rel="noopener nofollow noreferrer">Debugger of jwt.io</a>. If you want more information about JWT, you can read <a href=https://www.rfc-editor.org/rfc/rfc7519 target=_blank rel="noopener nofollow noreferrer">RFC 7519</a> or <a href=https://jwt.io/ target=_blank rel="noopener nofollow noreferrer">jwt.io</a> or read an <a href=https://www.sainth.de/blog/jwts-and-basic-auth/ target=_blank rel="noopener nofollow noreferrer">article</a> I wrote about it years ago.</p><div class="message is-danger"><div class=message-body>The way we use JWTs here, i.e. as part of JWS, the information contained is readable by everyone and thus should NOT contain sensitive information!</div></div><p>So, enough of the theory, let&rsquo;s put it into practice. But before we can start, we have to add support for JWTs to the authentication server in the form of an <a href=https://github.com/fenix-hub/godot-engine.jwt/tree/main-godot4 target=_blank rel="noopener nofollow noreferrer">AddOn</a>. To do this, we first download the <a href=https://github.com/fenix-hub/godot-engine.jwt/releases target=_blank rel="noopener nofollow noreferrer">latest release</a> for Godot 4 and unpack the folder <code>addons</code> into our Godot project of the Authentication Server. Afterwards we have to activate the add-on in the <code>project settings -> plugins</code>. To put everything into operation, we still need a key pair in <a href=https://en.wikipedia.org/wiki/Privacy_Enhanced_Mail target=_blank rel="noopener nofollow noreferrer">PEM format</a>. Since I work mostly under Linux, I use the appropriate Linux commands here, but with a short research you should also be able to find the appropriate commands for Windows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>authentication_server&gt; mkdir crypto
</span></span><span style=display:flex><span>authentication_server&gt; cd crypto
</span></span><span style=display:flex><span>authentication_server/crypto&gt; ssh-keygen -t rsa -b <span style=color:#ae81ff>4096</span> -m pem -f jwt_rsa.key
</span></span><span style=display:flex><span>authentication_server/crypto&gt; ssh-keygen -f jwt_rsa.key.pub -e -m pem &gt; jwt_rsa.pem
</span></span><span style=display:flex><span>authentication_server/crypto&gt; rm jwt_rsa.key.pub</span></span></code></pre></div><div class="message is-warning"><div class=message-body>Since I can think of few cases where it would not be negligent to feed (private) keys into a repository, I added the <code>crypto/</code> folder in the associated <code>.gitignore</code> of the authentication server.</div></div><p>Now we are finally really ready to extend the authentication server with token generation. The first step is to create a central variable of type <code>JWTAlgorithm</code> (line 10), which we then initialize in <code>_ready()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#66d9ef>var</span> jwt_algorithm: JWTAlgorithm
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#66d9ef>func</span> _ready() <span style=color:#f92672>-&gt;</span> void:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#66d9ef>var</span> private_key :<span style=color:#f92672>=</span> CryptoKey<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#66d9ef>var</span> load_ret :<span style=color:#f92672>=</span> private_key<span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;res://crypto/jwt_rsa.key&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#66d9ef>if</span> load_ret <span style=color:#f92672>==</span> OK:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		jwt_algorithm <span style=color:#f92672>=</span> JWTAlgorithm<span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		jwt_algorithm<span style=color:#f92672>.</span>_private_crypto <span style=color:#f92672>=</span> private_key
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		jwt_algorithm<span style=color:#f92672>.</span>_alg <span style=color:#f92672>=</span> JWTAlgorithm<span style=color:#f92672>.</span>Type<span style=color:#f92672>.</span>RSA256
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		print(<span style=color:#e6db74>&#34;Error while reading RSA private key: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> load_ret)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>		get_tree()<span style=color:#f92672>.</span>quit(load_ret)</span></span></code></pre></div><p>Before we can initialize <code>jwt_algorithm</code>, we must first load our private key (lines 14-15). If this worked, we create a new object of type <code>JWTAlgorithm</code> (line 17) and initialize it with the private key and our chosen hashing/signing method (lines 18-19). If something went wrong while loading the private key, we terminate the authentication server, because it will not be able to generate tokens without a private key.</p><p>Now, to create a real token, we replace the previous <code>pass</code> of line 78 in <code>s_authenticate_player()</code> of the previous section, with the following lines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>		<span style=color:#66d9ef>var</span> now :<span style=color:#f92672>=</span> <span style=color:#a6e22e>int</span>(Time<span style=color:#f92672>.</span>get_unix_time_from_system())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>		token <span style=color:#f92672>=</span> JWT<span style=color:#f92672>.</span>create(jwt_algorithm) \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>					<span style=color:#f92672>.</span>with_issued_at(now) \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>					<span style=color:#f92672>.</span>with_expires_at(now <span style=color:#f92672>+</span> <span style=color:#ae81ff>30</span>) \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>					<span style=color:#f92672>.</span>with_claim(<span style=color:#e6db74>&#34;acc&#34;</span>, username) \
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>					<span style=color:#f92672>.</span>sign(jwt_algorithm)</span></span></code></pre></div><p>This generates a token with a validity of 30 seconds, which contains the account name of the authenticated game client in the <code>acc</code> claim. The game client thus has about 30 seconds to authenticate itself with the world server using this token, provided that the system times of the authentication and world servers are approximately the same.</p><h3 class="title is-4" id=the-next-step>The next step</h3><div class="message is-warning"><div class=message-body>For a productive operation, all network communication must be encrypted, after all, passwords are transmitted. This is possible with <a href=https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security target=_blank rel="noopener nofollow noreferrer">DTLS</a>. DTLS is the UDP equivalent of TLS, which is used for HTTPS, for example. We will deal with the integration of DTLS in a later part of this tutorial series.</div></div><p>The next article will be about the next step: The game client sends the received token to the world server, which validates the token and maintains the connection if successful.</p></div></article><footer class=columns><div class="column has-text-left"><a href=/en/blog/2023/network-tutorial-3-login-1/ class="button right"><span class=icon-text><span class=icon><i class="fa fa-angle-left"></i></span><span>Networking tutorial 3: Login 1 - The game client</span></span></a></div><div class="column has-text-right"><a href=/en/blog/2023/network-tutorial-5-login-3/ class="button left"><span class=icon-text><span>Networking tutorial 5: Login 3 - world server</span><span class=icon><i class="fa fa-angle-right"></i></span></span></a></div></footer></div></div></div></section><footer class=footer><div class="container is-fluid has-text-centered"><ul class=socnet-icons><span class=icon><a href=//github.com/somethinglikegames target=_blank rel=noopener title=GitHub class="fab fa-github"></a></span>
<span class=icon><a href=//youtube.com/@somethinglikegames target=_blank rel=noopener title=YouTube class="fab fa-youtube"></a></span>
<span id=cloaked-e0ba0424cd></span>
<script id=cloaked-script-e0ba0424cd>var cloakElement=document.getElementById("cloaked-e0ba0424cd"),link=document.createElement("a"),address="ed.semagekilgnihtemos@ofni".split("").reverse().join("");link.href="mailto:"+address,link.classList="far fa-envelope",link.title="email",cloakElement.parentNode.replaceChild(link,cloakElement)</script></ul><p class=copyright><a href=https://www.somethinglikegames.de/en/legal_notice/>Legal Notice</a> &mdash;
<a href=https://www.somethinglikegames.de/en/privacy_policy/>Privacy Policy</a> &mdash;
Â©2023 Tobias Wink<br>Powered by <a href=https://gohugo.io/ title=0.109.0 target=_blank rel=noopener>Hugo</a></p></div></footer><script src=/js/navbar.min.js defer></script>
<script src=/js/copy-code-button.min.js defer></script></body></html>